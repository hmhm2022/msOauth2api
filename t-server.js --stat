warning: in the working copy of 'test-server.js', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/api/process-inbox.js b/api/clear-inbox.js[m
[1msimilarity index 100%[m
[1mrename from api/process-inbox.js[m
[1mrename to api/clear-inbox.js[m
[1mdiff --git a/api/process-junk.js b/api/clear-junk.js[m
[1msimilarity index 100%[m
[1mrename from api/process-junk.js[m
[1mrename to api/clear-junk.js[m
[1mdiff --git a/public/mail.html b/public/mail.html[m
[1mindex e75a15d..65323b5 100644[m
[1m--- a/public/mail.html[m
[1m+++ b/public/mail.html[m
[36m@@ -231,6 +231,7 @@[m
         .mailbox-item {[m
             padding: 8px 12px;[m
             border: 1px solid #ddd;[m
[32m+[m[32m            border-left-width: 2px;[m
             margin-bottom: 6px;[m
             border-radius: 4px;[m
             background-color: white;[m
[36m@@ -252,6 +253,61 @@[m
             border-color: #3498db;[m
         }[m
 [m
[32m+[m[32m        /* API ç±»å‹æ ·å¼ - Graph API */[m
[32m+[m[32m        .mailbox-item.api-graph {[m
[32m+[m[32m            border-color: #0078d4;[m
[32m+[m[32m            border-left-color: #0078d4;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        .mailbox-item.api-graph.selected {[m
[32m+[m[32m            background-color: #e3f2fd;[m
[32m+[m[32m            border-color: #0078d4;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        .mailbox-item.api-graph:hover {[m
[32m+[m[32m            background-color: #f0f7ff;[m
[32m+[m[32m            border-color: #0078d4;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /* API ç±»å‹æ ·å¼ - IMAP */[m
[32m+[m[32m        .mailbox-item.api-imap {[m
[32m+[m[32m            border-color: #ff8c00;[m
[32m+[m[32m            border-left-color: #ff8c00;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        .mailbox-item.api-imap.selected {[m
[32m+[m[32m            background-color: #fff3e0;[m
[32m+[m[32m            border-color: #ff8c00;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        .mailbox-item.api-imap:hover {[m
[32m+[m[32m            background-color: #fff8f0;[m
[32m+[m[32m            border-color: #ff8c00;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /* API ç±»å‹æ ·å¼ - æ£€æµ‹ä¸­ */[m
[32m+[m[32m        .mailbox-item.api-detecting {[m
[32m+[m[32m            border-color: #95a5a6;[m
[32m+[m[32m            border-left-color: #95a5a6;[m
[32m+[m[32m            border-style: dashed;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        .mailbox-item.api-detecting.selected {[m
[32m+[m[32m            background-color: #f5f5f5;[m
[32m+[m[32m            border-color: #95a5a6;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /* API ç±»å‹æ ·å¼ - æœªçŸ¥ */[m
[32m+[m[32m        .mailbox-item.api-unknown {[m
[32m+[m[32m            border-color: #e0e0e0;[m
[32m+[m[32m            border-left-color: #e0e0e0;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        .mailbox-item.api-unknown.selected {[m
[32m+[m[32m            background-color: #fafafa;[m
[32m+[m[32m            border-color: #e0e0e0;[m
[32m+[m[32m        }[m
[32m+[m
         .mailbox-email {[m
             font-weight: bold;[m
             font-size: 0.9rem;[m
[36m@@ -261,6 +317,32 @@[m
             flex: 1;[m
         }[m
 [m
[32m+[m[32m        .api-type-icon {[m
[32m+[m[32m            position: absolute;[m
[32m+[m[32m            left: 4px;[m
[32m+[m[32m            top: 4px;[m
[32m+[m[32m            font-size: 8px;[m
[32m+[m[32m            width: 8px;[m
[32m+[m[32m            height: 8px;[m
[32m+[m[32m            line-height: 8px;[m
[32m+[m[32m            text-align: center;[m
[32m+[m[32m            z-index: 1;[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        /* æ£€æµ‹ä¸­å›¾æ ‡æ—‹è½¬åŠ¨ç”» */[m
[32m+[m[32m        @keyframes rotate {[m
[32m+[m[32m            from {[m
[32m+[m[32m                transform: rotate(0deg);[m
[32m+[m[32m            }[m
[32m+[m[32m            to {[m
[32m+[m[32m                transform: rotate(360deg);[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        .api-type-icon.detecting {[m
[32m+[m[32m            animation: rotate 2s linear infinite;[m
[32m+[m[32m        }[m
[32m+[m
         .delete-mailbox {[m
             margin-left: 10px;[m
             background-color: transparent;[m
[36m@@ -878,9 +960,9 @@[m
                     <div class="control-group" style="margin-bottom: 0;">[m
                         <button onclick="checkTokenInfo()">æ£€æµ‹Tokenä¿¡æ¯</button>[m
                         <button class="secondary" onclick="clearEmailDisplay()">æ¸…é™¤æ˜¾ç¤º</button>[m
[32m+[m[32m                        <button class="warning" onclick="deleteSelectedEmail()">åˆ é™¤é€‰ä¸­é‚®ä»¶</button>[m
                         <button class="warning" onclick="clearInbox()">æ¸…ç©ºæ”¶ä»¶ç®±</button>[m
                         <button class="warning" onclick="clearJunk()">æ¸…ç©ºåƒåœ¾ç®±</button>[m
[31m-                        <button class="warning" onclick="deleteSelectedEmail()">åˆ é™¤é€‰ä¸­é‚®ä»¶</button>[m
                     </div>[m
                 </div>[m
             </div>[m
[36m@@ -1146,6 +1228,17 @@[m
             // åˆå§‹åŒ–å ä½ç¬¦[m
             updatePlaceholder();[m
 [m
[32m+[m[32m            // å…ˆåŠ è½½ API å¯†ç å’Œåœ°å€ï¼ˆå¿…é¡»åœ¨ loadMailboxesFromStorage ä¹‹å‰ï¼‰[m
[32m+[m[32m            const savedApiPassword = localStorage.getItem('apiPassword');[m
[32m+[m[32m            if (savedApiPassword) {[m
[32m+[m[32m                document.getElementById('apiPassword').value = savedApiPassword;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            const savedApiBaseUrl = localStorage.getItem('apiBaseUrl');[m
[32m+[m[32m            if (savedApiBaseUrl) {[m
[32m+[m[32m                document.getElementById('apiBaseUrl').value = savedApiBaseUrl;[m
[32m+[m[32m            }[m
[32m+[m
             // å°è¯•ä»localStorageåŠ è½½å·²ä¿å­˜çš„é‚®ç®±ä¿¡æ¯[m
             loadMailboxesFromStorage();[m
 [m
[36m@@ -1160,17 +1253,6 @@[m
                 currentEmailDisplay.style.display = 'block';[m
             }[m
 [m
[31m-            // å°è¯•ä»localStorageåŠ è½½å·²ä¿å­˜çš„APIå¯†ç å’Œåœ°å€[m
[31m-            const savedApiPassword = localStorage.getItem('apiPassword');[m
[31m-            if (savedApiPassword) {[m
[31m-                document.getElementById('apiPassword').value = savedApiPassword;[m
[31m-            }[m
[31m-[m
[31m-            const savedApiBaseUrl = localStorage.getItem('apiBaseUrl');[m
[31m-            if (savedApiBaseUrl) {[m
[31m-                document.getElementById('apiBaseUrl').value = savedApiBaseUrl;[m
[31m-            }[m
[31m-[m
             // å°è¯•ä»localStorageåŠ è½½è®¾ç½®åŒºåŸŸçš„æŠ˜å çŠ¶æ€[m
             const importSectionCollapsed = localStorage.getItem('importSectionCollapsed');[m
             if (importSectionCollapsed === 'true') {[m
[36m@@ -1278,6 +1360,9 @@[m
                     mailboxes = JSON.parse(savedMailboxes);[m
                     updateMailboxList();[m
                     setStatusMessage('å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½é‚®ç®±ä¿¡æ¯', 'success');[m
[32m+[m
[32m+[m[32m                    // å¼‚æ­¥æ£€æµ‹æœªçŸ¥çš„ API ç±»å‹[m
[32m+[m[32m                    detectUnknownApiTypes();[m
                 } catch (error) {[m
                     console.error('åŠ è½½é‚®ç®±ä¿¡æ¯å¤±è´¥:', error);[m
                     setStatusMessage('åŠ è½½é‚®ç®±ä¿¡æ¯å¤±è´¥', 'error');[m
[36m@@ -1285,6 +1370,23 @@[m
             }[m
         }[m
 [m
[32m+[m[32m        // æ£€æµ‹æ‰€æœ‰æœªçŸ¥ API ç±»å‹çš„é‚®ç®±[m
[32m+[m[32m        async function detectUnknownApiTypes() {[m
[32m+[m[32m            const promises = [];[m
[32m+[m[32m            mailboxes.forEach((mailbox, index) => {[m
[32m+[m[32m                // åªæ£€æµ‹æœªè®¾ç½®æˆ–æœªçŸ¥çš„é‚®ç®±[m
[32m+[m[32m                if (!mailbox.apiType || mailbox.apiType === 'unknown') {[m
[32m+[m[32m                    promises.push(detectApiType(index));[m
[32m+[m[32m                }[m
[32m+[m[32m            });[m
[32m+[m
[32m+[m[32m            if (promises.length > 0) {[m
[32m+[m[32m                console.log(`å¼€å§‹æ£€æµ‹ ${promises.length} ä¸ªé‚®ç®±çš„ API ç±»å‹...`);[m
[32m+[m[32m                await Promise.all(promises);[m
[32m+[m[32m                console.log('API ç±»å‹æ£€æµ‹å®Œæˆ');[m
[32m+[m[32m            }[m
[32m+[m[32m        }[m
[32m+[m
         // ä¿å­˜é‚®ç®±ä¿¡æ¯åˆ°localStorage[m
         function saveMailboxesToStorage() {[m
             try {[m
[36m@@ -1388,14 +1490,16 @@[m
                         email: parts[0],[m
                         password: parts[1],[m
                         client_id: parts[2],[m
[31m-                        refresh_token: parts[3][m
[32m+[m[32m                        refresh_token: parts[3],[m
[32m+[m[32m                        apiType: 'detecting'  // åˆå§‹åŒ–ä¸ºæ£€æµ‹ä¸­[m
                     });[m
                 } else if (isFormat2) {[m
                     newMailboxes.push({[m
                         email: parts[0],[m
                         password: parts[1],[m
                         client_id: parts[3],[m
[31m-                        refresh_token: parts[2][m
[32m+[m[32m                        refresh_token: parts[2],[m
[32m+[m[32m                        apiType: 'detecting'  // åˆå§‹åŒ–ä¸ºæ£€æµ‹ä¸­[m
                     });[m
                 }[m
             }[m
[36m@@ -1425,6 +1529,98 @@[m
 [m
             // æ¸…ç©ºè¾“å…¥æ¡†[m
             document.getElementById('mailboxInput').value = '';[m
[32m+[m
[32m+[m[32m            // å¼‚æ­¥æ£€æµ‹æ–°æ·»åŠ é‚®ç®±çš„ API ç±»å‹[m
[32m+[m[32m            console.log(`å‡†å¤‡æ£€æµ‹ ${newMailboxes.length} ä¸ªæ–°é‚®ç®±çš„ API ç±»å‹`);[m
[32m+[m[32m            setTimeout(() => {[m
[32m+[m[32m                detectApiTypesForNewMailboxes(mailboxes.length - newMailboxes.length, newMailboxes.length);[m
[32m+[m[32m            }, 100);[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // å¼‚æ­¥æ£€æµ‹é‚®ç®±çš„ API ç±»å‹[m
[32m+[m[32m        async function detectApiType(mailboxIndex) {[m
[32m+[m[32m            const mailbox = mailboxes[mailboxIndex];[m
[32m+[m[32m            if (!mailbox) {[m
[32m+[m[32m                console.warn(`é‚®ç®±ç´¢å¼• ${mailboxIndex} ä¸å­˜åœ¨`);[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            console.log(`[æ£€æµ‹] é‚®ç®± ${mailbox.email} å½“å‰çŠ¶æ€: ${mailbox.apiType}`);[m
[32m+[m
[32m+[m[32m            // å¦‚æœå·²ç»æœ‰æ˜ç¡®çš„ API ç±»å‹ï¼ˆgraph æˆ– imapï¼‰ï¼Œè·³è¿‡æ£€æµ‹[m
[32m+[m[32m            if (mailbox.apiType === 'graph' || mailbox.apiType === 'imap') {[m
[32m+[m[32m                console.log(`[è·³è¿‡] é‚®ç®± ${mailbox.email} å·²æœ‰ API ç±»å‹: ${mailbox.apiType}`);[m
[32m+[m[32m                return;[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // æ ‡è®°ä¸ºæ£€æµ‹ä¸­[m
[32m+[m[32m            mailbox.apiType = 'detecting';[m
[32m+[m[32m            console.log(`[å¼€å§‹] æ£€æµ‹é‚®ç®± ${mailbox.email} çš„ API ç±»å‹`);[m
[32m+[m[32m            updateMailboxList();[m
[32m+[m[32m            saveMailboxesToStorage();[m
[32m+[m
[32m+[m[32m            try {[m
[32m+[m[32m                // è·å– API åŸºç¡€åœ°å€[m
[32m+[m[32m                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();[m
[32m+[m[32m                if (!apiBaseUrl) {[m
[32m+[m[32m                    console.warn('[é”™è¯¯] æœªè®¾ç½® API åœ°å€ï¼Œæ— æ³•æ£€æµ‹ API ç±»å‹');[m
[32m+[m[32m                    mailbox.apiType = 'unknown';[m
[32m+[m[32m                    updateMailboxList();[m
[32m+[m[32m                    saveMailboxesToStorage();[m
[32m+[m[32m                    return;[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                // è·å– API å¯†ç [m
[32m+[m[32m                const apiPassword = document.getElementById('apiPassword').value.trim();[m
[32m+[m
[32m+[m[32m                // è°ƒç”¨ token-info API[m
[32m+[m[32m                const url = `${apiBaseUrl}/token-info?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}&password=${encodeURIComponent(apiPassword)}`;[m
[32m+[m
[32m+[m[32m                console.log(`[è¯·æ±‚] è°ƒç”¨ token-info API: ${apiBaseUrl}/token-info`);[m
[32m+[m
[32m+[m[32m                const response = await fetch(url);[m
[32m+[m[32m                console.log(`[å“åº”] HTTP çŠ¶æ€: ${response.status}`);[m
[32m+[m
[32m+[m[32m                if (!response.ok) {[m
[32m+[m[32m                    const errorText = await response.text();[m
[32m+[m[32m                    console.error(`[é”™è¯¯] HTTP error! status: ${response.status}, body: ${errorText}`);[m
[32m+[m[32m                    throw new Error(`HTTP error! status: ${response.status}`);[m
[32m+[m[32m                }[m
[32m+[m
[32m+[m[32m                const data = await response.json();[m
[32m+[m[32m                console.log(`[æ•°æ®] token-info è¿”å›:`, data);[m
[32m+[m
[32m+[m[32m                if (data.success && data.tokenInfo) {[m
[32m+[m[32m                    // æ ¹æ® primaryMode è®¾ç½® API ç±»å‹[m
[32m+[m[32m                    mailbox.apiType = data.tokenInfo.primaryMode || 'unknown';[m
[32m+[m[32m                    console.log(`[æˆåŠŸ] é‚®ç®± ${mailbox.email} çš„ API ç±»å‹: ${mailbox.apiType}`);[m
[32m+[m[32m                } else {[m
[32m+[m[32m                    mailbox.apiType = 'unknown';[m
[32m+[m[32m                    console.warn(`[è­¦å‘Š] æ— æ³•ç¡®å®šé‚®ç®± ${mailbox.email} çš„ API ç±»å‹ï¼Œè¿”å›æ•°æ®:`, data);[m
[32m+[m[32m                }[m
[32m+[m[32m            } catch (error) {[m
[32m+[m[32m                console.error(`[å¼‚å¸¸] æ£€æµ‹é‚®ç®± ${mailbox.email} çš„ API ç±»å‹å¤±è´¥:`, error);[m
[32m+[m[32m                mailbox.apiType = 'unknown';[m
[32m+[m[32m            }[m
[32m+[m
[32m+[m[32m            // æ›´æ–°æ˜¾ç¤ºå’Œå­˜å‚¨[m
[32m+[m[32m            console.log(`[å®Œæˆ] é‚®ç®± ${mailbox.email} æœ€ç»ˆ API ç±»å‹: ${mailbox.apiType}`);[m
[32m+[m[32m            updateMailboxList();[m
[32m+[m[32m            saveMailboxesToStorage();[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // æ‰¹é‡æ£€æµ‹æ–°æ·»åŠ é‚®ç®±çš„ API ç±»å‹[m
[32m+[m[32m        async function detectApiTypesForNewMailboxes(startIndex, count) {[m
[32m+[m[32m            console.log(`[æ‰¹é‡æ£€æµ‹] å¼€å§‹æ£€æµ‹ ${count} ä¸ªé‚®ç®±ï¼Œèµ·å§‹ç´¢å¼•: ${startIndex}`);[m
[32m+[m[32m            const promises = [];[m
[32m+[m[32m            for (let i = 0; i < count; i++) {[m
[32m+[m[32m                const index = startIndex + i;[m
[32m+[m[32m                console.log(`[æ‰¹é‡æ£€æµ‹] æ·»åŠ æ£€æµ‹ä»»åŠ¡: ç´¢å¼• ${index}`);[m
[32m+[m[32m                promises.push(detectApiType(index));[m
[32m+[m[32m            }[m
[32m+[m[32m            console.log(`[æ‰¹é‡æ£€æµ‹] ç­‰å¾… ${promises.length} ä¸ªæ£€æµ‹ä»»åŠ¡å®Œæˆ...`);[m
[32m+[m[32m            await Promise.all(promises);[m
[32m+[m[32m            console.log(`[æ‰¹é‡æ£€æµ‹] æ‰€æœ‰æ£€æµ‹ä»»åŠ¡å®Œæˆ`);[m
         }[m
 [m
         // æ›´æ–°é‚®ç®±åˆ—è¡¨æ˜¾ç¤º[m
[36m@@ -1448,7 +1644,18 @@[m
 [m
             mailboxes.forEach((mailbox, index) => {[m
                 const item = document.createElement('li');[m
[31m-                item.className = 'mailbox-item' + (index === selectedMailboxIndex ? ' selected' : '');[m
[32m+[m
[32m+[m[32m                // æ ¹æ® API ç±»å‹æ·»åŠ æ ·å¼ç±»[m
[32m+[m[32m                let apiTypeClass = 'api-unknown';[m
[32m+[m[32m                if (mailbox.apiType === 'graph') {[m
[32m+[m[32m                    apiTypeClass = 'api-graph';[m
[32m+[m[32m                } else if (mailbox.apiType === 'imap') {[m
[32