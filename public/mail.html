<!DOCTYPE html>
<html>
<head>
    <title>Easy Outlook</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f5f5;
        }

        .app-container {
            display: grid;
            grid-template-columns: 350px 350px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            border-collapse: collapse;
        }

        .header {
            grid-column: 1 / 4;
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #1a2530;
            height: 60px;
            box-sizing: border-box;
        }

        .current-email-display {
            background-color: white;
            color: #9b59b6;
            padding: 5px 10px;
            border: 2px solid #9b59b6;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-left: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 600px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .current-email-display:hover {
            background-color: #9b59b6;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(155, 89, 182, 0.3);
        }

        .current-email-display:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(155, 89, 182, 0.3);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .sidebar, .email-sidebar {
            grid-row: 2;
            background-color: #f0f0f0;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: calc(100vh - 60px); /* å‡å»å¤´éƒ¨é«˜åº¦ */
        }

        /* ç»Ÿä¸€æ‰€æœ‰åŒºåŸŸçš„è¾¹æ¡†æ ·å¼ */
        .sidebar, .email-sidebar, .main-content {
            border-top: none;
        }

        /* å¯¼å…¥é‚®ç®±åŒºåŸŸæ ·å¼ */
        .sidebar > .sidebar-section:first-child {
            overflow-y: visible;
        }

        .sidebar {
            grid-column: 1;
        }

        .email-sidebar {
            grid-column: 2;
        }

        .main-content {
            grid-column: 3;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: calc(100vh - 60px); /* å‡å»å¤´éƒ¨é«˜åº¦ */
        }

        /* ç»Ÿä¸€æ‰€æœ‰åŒºåŸŸçš„å†…éƒ¨åˆ†ç•Œçº¿æ ·å¼ */
        .sidebar-section, .main-toolbar, .tabs, .email-sidebar .sidebar-section {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            height: 42px; /* å›ºå®šé«˜åº¦ç¡®ä¿ä¸€è‡´æ€§ */
            box-sizing: border-box;
            display: flex;
            align-items: center;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 0;
        }

        /* ç»Ÿä¸€æ ‡é¢˜æ–‡æœ¬æ ·å¼ */
        .sidebar-section h2, .email-sidebar .sidebar-section h2 {
            font-size: 0.95rem;
            margin-bottom: 0;
            margin-top: 0;
            color: #333;
            line-height: 1.2;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #555;
            font-size: 1rem;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            transform: rotate(0deg);
        }

        .toggle-btn.collapsed {
            transform: rotate(-90deg);
        }

        .toggle-btn:hover {
            color: #3498db;
            background: none;
        }

        .section-content {
            overflow: hidden;
            transition: all 0.3s ease;
            max-height: 1000px; /* è¶³å¤Ÿå¤§çš„é«˜åº¦æ¥å®¹çº³å†…å®¹ */
            border-top: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 0;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0;
            margin: 0;
            border: 0;
            opacity: 0;
            visibility: hidden;
        }

        .input-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: #555;
        }

        button {
            padding: 6px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .small-btn {
            padding: 3px 8px;
            font-size: 0.75rem;
        }

        button:hover {
            background-color: #2980b9;
        }

        button.secondary {
            background-color: #95a5a6;
        }

        button.secondary:hover {
            background-color: #7f8c8d;
        }

        button.warning {
            background-color: #e74c3c;
        }

        button.warning:hover {
            background-color: #c0392b;
        }

        .mailbox-list, .email-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            list-style-type: none;
            max-height: calc(100vh - 102px); /* å‡å»å¤´éƒ¨é«˜åº¦å’Œå·¥å…·æ é«˜åº¦ */
            margin: 0;
            border-top: 1px solid #ddd;
        }

        .mailbox-item {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-left-width: 2px;
            margin-bottom: 6px;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mailbox-item:hover {
            background-color: #f5f5f5;
            border-color: #bbb;
        }

        .mailbox-item.selected {
            background-color: #e1f0fa;
            border-color: #3498db;
        }

        /* API ç±»å‹æ ·å¼ - Graph API */
        .mailbox-item.api-graph {
            border-color: #0078d4;
            border-left-color: #0078d4;
        }

        .mailbox-item.api-graph.selected {
            background-color: #e3f2fd;
            border-color: #0078d4;
        }

        .mailbox-item.api-graph:hover {
            background-color: #f0f7ff;
            border-color: #0078d4;
        }

        /* API ç±»å‹æ ·å¼ - IMAP */
        .mailbox-item.api-imap {
            border-color: #ff8c00;
            border-left-color: #ff8c00;
        }

        .mailbox-item.api-imap.selected {
            background-color: #fff3e0;
            border-color: #ff8c00;
        }

        .mailbox-item.api-imap:hover {
            background-color: #fff8f0;
            border-color: #ff8c00;
        }

        /* API ç±»å‹æ ·å¼ - æ£€æµ‹ä¸­ */
        .mailbox-item.api-detecting {
            border-color: #95a5a6;
            border-left-color: #95a5a6;
            border-style: dashed;
        }

        .mailbox-item.api-detecting.selected {
            background-color: #f5f5f5;
            border-color: #95a5a6;
        }

        /* API ç±»å‹æ ·å¼ - æœªçŸ¥ */
        .mailbox-item.api-unknown {
            border-color: #e0e0e0;
            border-left-color: #e0e0e0;
        }

        .mailbox-item.api-unknown.selected {
            background-color: #fafafa;
            border-color: #e0e0e0;
        }

        .mailbox-email {
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .api-type-icon {
            position: absolute;
            left: 4px;
            top: 4px;
            font-size: 8px;
            width: 8px;
            height: 8px;
            line-height: 8px;
            text-align: center;
            z-index: 1;
        }

        /* æ£€æµ‹ä¸­å›¾æ ‡æ—‹è½¬åŠ¨ç”» */
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .api-type-icon.detecting {
            animation: rotate 2s linear infinite;
        }

        .delete-mailbox {
            margin-left: 10px;
            background-color: transparent;
            color: #999;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .delete-mailbox:hover {
            background-color: #e74c3c;
            color: white;
            border-color: #c0392b;
            opacity: 1;
        }

        .view-credentials-btn {
            margin-left: 5px;
            background-color: transparent;
            color: #3498db;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: normal;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .view-credentials-btn:hover {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
            opacity: 1;
        }

        .mailbox-buttons {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background-color: #f5f5f5;
            color: #333;
        }

        .credential-item {
            margin-bottom: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .credential-label {
            font-size: 0.9rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 8px;
            display: block;
        }

        .credential-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .credential-text {
            flex: 1;
            font-family: monospace;
            font-size: 0.9rem;
            color: #333;
            background-color: white;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            word-break: break-all;
            min-height: 20px;
        }

        .copy-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background-color: #218838;
        }

        .copy-btn.copied {
            background-color: #6c757d;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .main-toolbar {
            background-color: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }



        select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 0.9rem;
        }

        .email-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: calc(100vh - 120px); /* å‡å»å¤´éƒ¨å’Œå·¥å…·æ çš„é«˜åº¦ */
        }

        .email-header {
            padding: 10px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
        }

        .email-subject {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .email-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #555;
        }

        .email-from { font-weight: bold; }

        .email-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 170px); /* å‡å»å¤´éƒ¨ã€å·¥å…·æ å’Œæ ‡ç­¾é¡µçš„é«˜åº¦ */
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .tabs {
            display: flex;
            background-color: #f8f8f8;
            align-items: center;
        }

        .tab {
            padding: 0 15px;
            cursor: pointer;
            border-right: 1px solid #ddd;
            font-size: 0.9rem;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .tab.active {
            background-color: white;
            border-bottom: 2px solid #3498db;
            height: calc(100% + 2px);
            position: relative;
            top: 1px;
        }

        .status-bar {
            padding: 8px 15px;
            font-size: 0.8rem;
            border-top: 1px solid #ddd;
            background-color: #f8f8f8;
        }

        .status-message {
            color: #333;
        }

        .status-message.error {
            color: #e74c3c;
        }

        .status-message.success {
            color: #27ae60;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-style: italic;
            color: #666;
            flex: 1;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .file-input-label {
            display: inline-block;
            padding: 6px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-bottom: 0;
        }

        .file-input-label:hover {
            background-color: #2980b9;
        }

        .file-input-wrapper {
            position: relative;
            margin-right: 10px;
            display: inline-block;
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            resize: none;
            font-family: inherit;
            box-sizing: border-box;
        }

        .dropzone {
            border: 2px dashed #ccc;
            transition: all 0.3s ease;
        }

        .dropzone::placeholder {
            font-size: 0.75rem; /* æ¯”æ­£å¸¸æ–‡æœ¬å°ä¸¤å· (0.85rem -> 0.75rem) */
            line-height: 1.3;
        }

        .dropzone.dragover {
            border-color: #3498db;
            background-color: #f0f8ff;
        }

        .drag-hint, .api-hint {
            font-size: 0.75rem;
            color: #777;
            margin-top: 3px;
            text-align: center;
            font-style: italic;
        }

        .api-hint {
            text-align: left;
            margin-top: 5px;
        }

        .api-hint a {
            color: #3498db;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .api-hint a:hover {
            text-decoration: underline;
        }

        .github-icon {
            margin-right: 3px;
            vertical-align: middle;
            position: relative;
            top: -1px;
        }

        .input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .separator-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .separator-input label {
            margin-bottom: 0;
            font-size: 0.8rem;
        }

        .small-input {
            width: 60px;
            padding: 2px 5px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 0;
            box-sizing: border-box;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #7f8c8d;
            padding: 20px;
            min-height: 100px;
            height: 100%;
            width: 100%;
        }

        .empty-state p {
            margin-bottom: 15px;
            text-align: center;
        }

        .raw-data {
            padding: 15px;
            overflow: auto;
            height: 100%;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            background-color: #f8f8f8;
            flex: 1;
        }

        .email-item {
            padding: 10px 15px;
            border: 1px solid #ddd;
            margin-bottom: 8px;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .email-item:hover {
            background-color: #f5f5f5;
            border-color: #bbb;
        }

        .email-item.selected {
            background-color: #e1f0fa;
            border-color: #3498db;
        }

        .email-item-subject {
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }

        .email-item-from {
            font-size: 0.8rem;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .email-item-date {
            font-size: 0.75rem;
            color: #777;
            margin-top: 5px;
        }

        /* é‚®ç®±åˆ†ç»„æ ·å¼ */
        .mailbox-group {
            margin-bottom: 10px;
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .group-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .group-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .group-toggle {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            color: white;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .group-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .group-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            flex: 1;
        }

        .group-count {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 8px;
        }

        .group-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .group-header:hover .group-actions {
            opacity: 1;
        }

        .group-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .group-action-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .group-content {
            overflow: hidden;
            transition: all 0.3s ease;
            max-height: 5000px;
            padding-left: 10px;
        }

        .group-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .group-content .mailbox-item {
            margin-bottom: 6px;
        }

        /* æ‹–æ‹½æ ·å¼ */
        .mailbox-item.dragging {
            opacity: 0.5;
            cursor: move;
        }

        .group-header.drag-over {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: scale(1.02);
        }

        .mailbox-item.drag-over {
            border-color: #3498db;
            background-color: #e8f4f8;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .mailbox-search-container {
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .mailbox-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.85rem;
            outline: none;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .mailbox-search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .mailbox-search-input::placeholder {
            color: #999;
        }

        /* åˆ†ç»„ç®¡ç†æ¨¡æ€æ¡† */
        .group-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .group-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .group-modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .group-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .group-modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .group-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .group-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: #fafafa;
            transition: all 0.2s;
        }

        .group-list-item:hover {
            background-color: #f0f0f0;
            border-color: #ccc;
        }

        .group-list-item-name {
            font-weight: 500;
            color: #333;
        }

        .group-list-item-count {
            color: #666;
            font-size: 0.85rem;
            margin-left: 10px;
        }

        .group-list-item-actions {
            display: flex;
            gap: 5px;
        }

        .new-group-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .new-group-input input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .new-group-input input:focus {
            border-color: #667eea;
        }

        /* æ— åˆ†ç»„æç¤º */
        .no-group-hint {
            text-align: center;
            color: #999;
            font-size: 0.85rem;
            padding: 20px;
            font-style: italic;
        }

        /* æœªåˆ†ç»„é‚®ç®±åˆ—è¡¨ */
        .ungrouped-mailboxes {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .ungrouped-mailbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: white;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .ungrouped-mailbox-item:hover {
            background-color: #f5f5f5;
            border-color: #ccc;
        }

        .ungrouped-mailbox-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .ungrouped-mailbox-item label {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        .ungrouped-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 6px;
            align-items: center;
        }

        .ungrouped-actions button {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .ungrouped-actions select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85rem;
            outline: none;
            cursor: pointer;
        }

        .ungrouped-actions select:focus {
            border-color: #667eea;
        }

        .expand-toggle {
            cursor: pointer;
            user-select: none;
            margin-left: 8px;
            color: #667eea;
            font-size: 0.9rem;
        }

        .expand-toggle:hover {
            color: #5568d3;
        }

        /* åˆ†ç»„å¾½ç« é¢œè‰² */
        .group-header.color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .group-header.color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .group-header.color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .group-header.color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .group-header.color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .group-header.color-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .group-header.color-7 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .group-header.color-8 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }

        /* åˆ é™¤åˆ†ç»„å¯¹è¯æ¡†æ ·å¼ */
        .delete-group-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .delete-group-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .delete-group-dialog h3 {
            margin: 0 0 16px 0;
            font-size: 20px;
            color: #333;
        }

        .delete-group-dialog .mailbox-count {
            margin: 0 0 20px 0;
            color: #666;
            font-size: 14px;
        }

        .delete-group-dialog .mailbox-count strong {
            color: #007bff;
            font-size: 16px;
        }

        .delete-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .delete-option {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .delete-option.danger:hover {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .delete-option input[type="radio"] {
            margin-top: 2px;
            margin-right: 12px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .delete-option .option-content {
            flex: 1;
        }

        .delete-option .option-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .delete-option .option-desc {
            font-size: 13px;
            color: #666;
        }

        .delete-option .option-desc.warning {
            color: #dc3545;
            font-weight: 500;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .dialog-buttons button {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dialog-buttons .cancel-btn {
            background: #f0f0f0;
            color: #333;
        }

        .dialog-buttons .cancel-btn:hover {
            background: #e0e0e0;
        }

        .dialog-buttons .confirm-btn {
            background: #007bff;
            color: white;
        }

        .dialog-buttons .confirm-btn:hover {
            background: #0056b3;
        }

        /* æ·»åŠ é‚®ç®±åˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†æ ·å¼ */
        .add-mailbox-group-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        .add-mailbox-group-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        .add-mailbox-group-dialog h3 {
            margin: 0 0 16px 0;
            font-size: 20px;
            color: #333;
        }

        .add-mailbox-group-dialog .group-select-wrapper {
            margin-bottom: 24px;
        }

        .add-mailbox-group-dialog .group-select-wrapper label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .add-mailbox-group-dialog .group-select-wrapper select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .add-mailbox-group-dialog .group-select-wrapper select:focus {
            outline: none;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div style="display: flex; align-items: center;">
                <h1>Easy Outlook----ä»¤ç‰Œå¿«æ·æ”¶å‘é‚®ä»¶</h1>
                <div id="currentEmailDisplay" class="current-email-display" style="display: none;" onclick="copyCurrentEmail()" title="ç‚¹å‡»å¤åˆ¶é‚®ç®±åœ°å€">å½“å‰é‚®ç®±: <span id="currentEmailText"></span></div>
            </div>
            <div id="statusMessage" class="status-message"></div>
        </header>

        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <!-- è®¾ç½®åŒºåŸŸ -->
            <div class="sidebar-section" id="importSection">
                <div class="section-header">
                    <h2>è®¾ç½®</h2>
                    <div style="display: flex; align-items: center;">
                        <span id="sectionStatus" style="font-size: 0.8rem; margin-right: 5px; color: #666;">å±•å¼€</span>
                        <button id="toggleImportBtn" class="toggle-btn" onclick="toggleImportSection()">â–¼</button>
                    </div>
                </div>
            </div>
            <div id="importContent" class="section-content">
                <div class="input-group">
                    <div class="input-header">
                        <label for="mailboxInput">æ‰‹åŠ¨è¾“å…¥é‚®ç®±é…ç½®</label>
                        <div class="separator-input">
                            <label for="separatorInput">åˆ†éš”ç¬¦:</label>
                            <input type="text" id="separatorInput" value="----" class="small-input">
                        </div>
                    </div>
                    <textarea id="mailboxInput" placeholder="æ”¯æŒä¸¤ç§æ ¼å¼:&#10;æ ¼å¼1: email----password----client_id----refresh_token&#10;æ ¼å¼2: email----password----refresh_token----client_id" class="dropzone"></textarea>
                    <div class="drag-hint">æ”¯æŒæ‹–æ›³æ–‡ä»¶ä¸Šä¼ </div>
                </div>
                <div class="control-group" style="margin-bottom: 15px;">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" class="file-input" accept=".txt">
                        <label for="fileInput" class="file-input-label">é€‰æ‹©æ–‡ä»¶</label>
                    </div>
                    <button onclick="parseMailboxInput()">æ·»åŠ é‚®ç®±</button>
                </div>
                <div class="input-group">
                    <label for="apiBaseUrl">APIåœ°å€ï¼ˆå¿…å¡«ï¼‰</label>
                    <input type="text" id="apiBaseUrl" placeholder="æ ¼å¼ä¸ºhttps://xxxx/api" class="form-control">
                    <div class="api-hint">è¯´æ˜ï¼šæ­å»ºAPIè¯·å‚è§ <a href="https://github.com/hmhm2022/msOauth2api" target="_blank"><svg class="github-icon" viewBox="0 0 16 16" width="14" height="14"><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg> msOauth2api</a> </div>
                </div>
                <div class="input-group">
                    <label for="apiPassword">APIå¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="password" id="apiPassword" placeholder="å¦‚æœæœåŠ¡å™¨è¦æ±‚å¯†ç éªŒè¯ï¼Œè¯·è¾“å…¥" class="form-control">
                </div>
                <div class="control-group" style="margin-top: 15px;">
                    <button onclick="saveApiSettings()" class="secondary">ä¿å­˜APIè®¾ç½®</button>
                </div>
            </div>

            <!-- é‚®ç®±åˆ—è¡¨åŒºåŸŸ -->
            <div class="sidebar-section">
                <div class="section-header">
                    <h2>é‚®ç®±åˆ—è¡¨</h2>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="openGroupManageModal()" class="small-btn" style="background-color: #667eea;">åˆ†ç»„ç®¡ç†</button>
                        <button onclick="clearMailboxes()" class="small-btn">æ¸…é™¤æ‰€æœ‰é‚®ç®±</button>
                    </div>
                </div>
            </div>

            <!-- æœç´¢æ¡† -->
            <div class="mailbox-search-container">
                <input type="text" id="mailboxSearchInput" class="mailbox-search-input" placeholder="ğŸ” æœç´¢é‚®ç®±åœ°å€..." oninput="filterMailboxes()">
            </div>

            <ul id="mailboxList" class="mailbox-list" style="position: relative; height: calc(100% - 84px);">
                <!-- é‚®ç®±åˆ—è¡¨é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
            </ul>
        </aside>

        <!-- é‚®ä»¶åˆ—è¡¨åŒºåŸŸ -->
        <aside class="email-sidebar">
            <div class="sidebar-section">
                <div class="section-header">
                    <h2>é‚®ä»¶åˆ—è¡¨</h2>
                    <div class="control-group" style="margin-bottom: 0;">
                        <select id="mailboxFolderList" onchange="loadEmailList(true)">
                            <option value="INBOX" selected>æ”¶ä»¶ç®±</option>
                            <option value="Junk">åƒåœ¾é‚®ä»¶</option>
                        </select>
                        <span id="emailCount" style="margin: 0 8px; color: #666; font-size: 0.9rem;">(0)</span>
                        <button onclick="loadEmailList(true)" class="small-btn">åˆ·æ–°</button>
                    </div>
                </div>
            </div>

            <ul id="emailList" class="email-list" style="flex: 1; height: calc(100% - 42px); position: relative;">
                <!-- é‚®ä»¶åˆ—è¡¨é¡¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                <div class="empty-state" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                    <p>é€‰æ‹©ä¸€ä¸ªé‚®ç®±æŸ¥çœ‹é‚®ä»¶</p>
                </div>
            </ul>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- å·¥å…·æ  -->
            <div class="main-toolbar">
                <div class="section-header">
                    <div class="control-group" style="margin-bottom: 0;">
                        <label for="responseType">æ ¼å¼:</label>
                        <select id="responseType">
                            <option value="json" selected>JSON</option>
                            <option value="html">HTML</option>
                        </select>
                        <button onclick="fetchEmail()">è·å–æœ€æ–°é‚®ä»¶</button>
                    </div>
                    <div class="control-group" style="margin-bottom: 0;">
                        <button onclick="checkTokenInfo()">æ£€æµ‹Tokenä¿¡æ¯</button>
                        <button class="secondary" onclick="clearEmailDisplay()">æ¸…é™¤æ˜¾ç¤º</button>
                        <button class="warning" onclick="deleteSelectedEmail()">åˆ é™¤é€‰ä¸­é‚®ä»¶</button>
                        <button class="warning" onclick="clearInbox()">æ¸…ç©ºæ”¶ä»¶ç®±</button>
                        <button class="warning" onclick="clearJunk()">æ¸…ç©ºåƒåœ¾ç®±</button>
                    </div>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('emailTab')">é‚®ä»¶å†…å®¹</div>
                <div class="tab" onclick="switchTab('rawTab')">JSONæ ¼å¼</div>
                <div class="tab" onclick="switchTab('sendMailTab')">å‘é€é‚®ä»¶</div>
                <div class="tab" onclick="switchTab('tokenInfoTab')">Tokenä¿¡æ¯</div>
                <div class="tab" onclick="switchTab('mailManageTab')">é‚®ä»¶ç®¡ç†</div>
            </div>

            <!-- é‚®ä»¶å†…å®¹åŒºåŸŸ -->
            <div id="emailTab" class="email-container" style="display: block;">
                <div id="emailHeader" class="email-header" style="display: none;">
                    <div id="emailSubject" class="email-subject"></div>
                    <div class="email-meta">
                        <div id="emailFrom" class="email-from"></div>
                        <div id="emailDate"></div>
                    </div>
                </div>

                <div id="emailViewer" class="email-viewer">
                    <div id="emptyState" class="empty-state" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                        <p>é€‰æ‹©ä¸€ä¸ªé‚®ç®±å¹¶ç‚¹å‡»"è·å–é‚®ä»¶"æ¥æŸ¥çœ‹æœ€æ–°é‚®ä»¶</p>
                    </div>
                    <div id="loadingMessage" class="loading" style="display: none;">
                        æ­£åœ¨åŠ è½½é‚®ä»¶å†…å®¹...
                    </div>
                    <iframe id="emailFrame" style="display: none; flex: 1;"></iframe>
                </div>
            </div>

            <!-- åŸå§‹æ•°æ®åŒºåŸŸ -->
            <div id="rawTab" class="email-container" style="display: none;">
                <pre id="rawData" class="raw-data"></pre>
            </div>

            <!-- å‘é€é‚®ä»¶åŒºåŸŸ -->
            <div id="sendMailTab" class="email-container" style="display: none;">
                <div style="padding: 20px;">
                    <h2 style="margin-bottom: 20px;">å‘é€é‚®ä»¶</h2>
                    <div class="input-group">
                        <label for="mailRecipient">æ”¶ä»¶äººé‚®ç®±</label>
                        <input type="text" id="mailRecipient" placeholder="ä¾‹å¦‚ï¼šnqaprav26185@outlook.com" class="form-control">
                    </div>
                    <div class="input-group">
                        <label for="mailSubject">é‚®ä»¶ä¸»é¢˜</label>
                        <input type="text" id="mailSubject" placeholder="è¯·è¾“å…¥é‚®ä»¶ä¸»é¢˜" class="form-control">
                    </div>
                    <div class="input-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label for="mailContent">é‚®ä»¶å†…å®¹</label>
                            <div>
                                <label style="display: inline; margin-right: 10px;">
                                    <input type="radio" name="contentType" value="text" checked onclick="setContentTemplate('text')"> çº¯æ–‡æœ¬
                                </label>
                                <label style="display: inline;">
                                    <input type="radio" name="contentType" value="html" onclick="setContentTemplate('html')"> HTMLæ ¼å¼
                                </label>
                            </div>
                        </div>
                        <textarea id="mailContent" placeholder="è¯·è¾“å…¥é‚®ä»¶å†…å®¹" class="form-control" style="height: 150px;"></textarea>
                    </div>
                    <div class="control-group" style="margin-top: 20px;">
                        <button onclick="sendMailGET()" class="secondary" style="margin-right: 10px;">GETæ–¹å¼å‘é€</button>
                        <button onclick="sendMailPOST()">æ ‡å‡†POSTæ–¹å¼å‘é€</button>
                    </div>
                    <div id="sendMailResult" style="margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; display: none;">
                        <h3>å‘é€ç»“æœ</h3>
                        <pre id="sendMailResultContent" style="white-space: pre-wrap; font-family: monospace;"></pre>
                    </div>
                </div>
            </div>

            <!-- Tokenä¿¡æ¯æ ‡ç­¾é¡µ -->
            <div id="tokenInfoTab" class="email-container" style="display: none;">
                <div style="padding: 20px;">
                    <h2 style="margin-bottom: 20px;">Tokenä¿¡æ¯æ£€æµ‹</h2>
                    <div class="control-group" style="margin-bottom: 20px;">
                        <button onclick="checkTokenInfo()">æ£€æµ‹å½“å‰é‚®ç®±Tokenä¿¡æ¯</button>
                        <button onclick="clearTokenInfo()" class="secondary">æ¸…é™¤æ˜¾ç¤º</button>
                    </div>

                    <div id="tokenInfoResult" style="display: none;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;">TokenåŸºæœ¬ä¿¡æ¯</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <strong>é‚®ç®±åœ°å€:</strong> <span id="tokenEmail">-</span>
                                </div>
                                <div>
                                    <strong>ä¸»è¦æ¨¡å¼:</strong> <span id="tokenPrimaryMode">-</span>
                                </div>
                                <div>
                                    <strong>æ”¯æŒçš„æ¨¡å¼:</strong> <span id="tokenSupportedModes">-</span>
                                </div>
                                <div>
                                    <strong>æ£€æµ‹æ—¶é—´:</strong> <span id="tokenTimestamp">-</span>
                                </div>
                            </div>
                        </div>

                        <div style="background: #e8f5e8; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #2d5a2d;">åŠŸèƒ½æ”¯æŒæƒ…å†µ</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div><span id="featureReadEmails">âŒ</span> è¯»å–é‚®ä»¶</div>
                                <div><span id="featureDeleteEmails">âŒ</span> åˆ é™¤é‚®ä»¶</div>
                                <div><span id="featureSendEmails">âŒ</span> å‘é€é‚®ä»¶</div>
                                <div><span id="featureClearInbox">âŒ</span> æ¸…ç©ºæ”¶ä»¶ç®±</div>
                                <div><span id="featureClearJunk">âŒ</span> æ¸…ç©ºåƒåœ¾ç®±</div>
                            </div>
                        </div>

                        <div style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #856404;">ä½¿ç”¨å»ºè®®</h3>
                            <ul id="tokenRecommendations" style="margin: 0; padding-left: 20px;">
                                <!-- å»ºè®®å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                            </ul>
                        </div>

                        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
                            <h3 style="margin-bottom: 15px; color: #333;">è¯¦ç»†æƒé™ä¿¡æ¯</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="color: #0066cc; margin-bottom: 10px;">Graph APIæƒé™</h4>
                                    <div id="graphApiPermissions">
                                        <div>æ”¯æŒçŠ¶æ€: <span id="graphApiSupported">-</span></div>
                                        <div>Mail.ReadWrite: <span id="graphMailReadWrite">-</span></div>
                                        <div>Mail.Read: <span id="graphMailRead">-</span></div>
                                        <div>User.Read: <span id="graphUserRead">-</span></div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: #cc6600; margin-bottom: 10px;">IMAPæƒé™</h4>
                                    <div id="imapPermissions">
                                        <div>æ”¯æŒçŠ¶æ€: <span id="imapSupported">-</span></div>
                                        <div>IMAPè®¿é—®: <span id="imapAccess">-</span></div>
                                        <div>POPè®¿é—®: <span id="popAccess">-</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é‚®ä»¶ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="mailManageTab" class="email-container" style="display: none;">
                <div style="padding: 20px;">
                    <h2 style="margin-bottom: 20px;">é‚®ä»¶ç®¡ç†åŠŸèƒ½</h2>

                    <!-- åˆ é™¤æŒ‡å®šé‚®ä»¶åŒºåŸŸ -->
                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #e74c3c;">åˆ é™¤æŒ‡å®šé‚®ä»¶</h3>
                        <div class="input-group">
                            <label for="deleteMailId">é‚®ä»¶ID (ä»é‚®ä»¶åˆ—è¡¨ä¸­è·å–)</label>
                            <input type="text" id="deleteMailId" placeholder="è¾“å…¥è¦åˆ é™¤çš„é‚®ä»¶ID" class="form-control">
                            <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                æç¤º: å¯ä»¥ä»é‚®ä»¶åˆ—è¡¨ä¸­ç‚¹å‡»é‚®ä»¶æŸ¥çœ‹å…¶IDï¼Œæˆ–åœ¨JSONæ ¼å¼æ ‡ç­¾é¡µä¸­æŸ¥çœ‹å®Œæ•´çš„é‚®ä»¶IDä¿¡æ¯
                            </div>
                        </div>
                        <div class="control-group" style="margin-top: 15px;">
                            <button onclick="deleteMailById()" class="warning">åˆ é™¤é‚®ä»¶</button>
                            <button onclick="fillSelectedEmailId()" class="secondary">ä½¿ç”¨é€‰ä¸­é‚®ä»¶ID</button>
                        </div>
                        <div id="deleteMailResult" style="margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; display: none;">
                            <h4>åˆ é™¤ç»“æœ</h4>
                            <pre id="deleteMailResultContent" style="white-space: pre-wrap; font-family: monospace; margin: 0;"></pre>
                        </div>
                    </div>

                    <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #f39c12;">æ‰¹é‡æ“ä½œ</h3>
                        <div class="control-group">
                            <button onclick="clearInboxWithStats()" class="warning">æ¸…ç©ºæ”¶ä»¶ç®± (æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡)</button>
                            <button onclick="clearJunkWithStats()" class="warning">æ¸…ç©ºåƒåœ¾ç®± (æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡)</button>
                        </div>
                        <div id="batchOperationResult" style="margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; display: none;">
                            <h4>æ“ä½œç»“æœ</h4>
                            <div id="batchOperationStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div><strong>ä½¿ç”¨æ¨¡å¼:</strong> <span id="batchMode">-</span></div>
                                <div><strong>æ€»é‚®ä»¶æ•°:</strong> <span id="batchTotal">-</span></div>
                                <div><strong>æˆåŠŸåˆ é™¤:</strong> <span id="batchDeleted">-</span></div>
                                <div><strong>åˆ é™¤å¤±è´¥:</strong> <span id="batchFailed">-</span></div>
                            </div>
                            <pre id="batchOperationDetails" style="white-space: pre-wrap; font-family: monospace; margin: 0; font-size: 0.9rem;"></pre>
                        </div>
                    </div>

                    <!-- é‚®ä»¶ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
                        <h3 style="margin-bottom: 15px; color: #3498db;">å½“å‰é€‰ä¸­é‚®ä»¶ä¿¡æ¯</h3>
                        <div id="selectedEmailInfo">
                            <div style="color: #666; font-style: italic;">è¯·ä»é‚®ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°é‚®ä»¶</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- é‚®ç®±å‡­æ®æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="credentialsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">é‚®ç®±å‡­æ®ä¿¡æ¯</h3>
                <button class="modal-close" onclick="closeCredentialsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="credential-item">
                    <label class="credential-label">é‚®ç®±åœ°å€</label>
                    <div class="credential-value">
                        <div id="modalEmail" class="credential-text"></div>
                        <button class="copy-btn" onclick="copyToClipboard('modalEmail', this)">å¤åˆ¶</button>
                    </div>
                </div>
                <div class="credential-item">
                    <label class="credential-label">é‚®ç®±å¯†ç </label>
                    <div class="credential-value">
                        <div id="modalPassword" class="credential-text"></div>
                        <button class="copy-btn" onclick="copyToClipboard('modalPassword', this)">å¤åˆ¶</button>
                    </div>
                </div>
                <div class="credential-item">
                    <label class="credential-label">Client ID</label>
                    <div class="credential-value">
                        <div id="modalClientId" class="credential-text"></div>
                        <button class="copy-btn" onclick="copyToClipboard('modalClientId', this)">å¤åˆ¶</button>
                    </div>
                </div>
                <div class="credential-item">
                    <label class="credential-label">Refresh Token</label>
                    <div class="credential-value">
                        <div id="modalRefreshToken" class="credential-text"></div>
                        <button class="copy-btn" onclick="copyToClipboard('modalRefreshToken', this)">å¤åˆ¶</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†ç»„ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="groupManageModal" class="group-modal">
        <div class="group-modal-content">
            <div class="group-modal-header">
                <h3 class="group-modal-title">ğŸ“ åˆ†ç»„ç®¡ç†</h3>
                <button class="modal-close" onclick="closeGroupManageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="group-list" id="groupListContainer">
                    <!-- åˆ†ç»„åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
                <div class="new-group-input">
                    <input type="text" id="newGroupNameInput" placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°..." maxlength="20">
                    <button onclick="createNewGroup()">åˆ›å»ºåˆ†ç»„</button>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <button onclick="autoGroupByDomain()" class="secondary" style="width: 100%;">ğŸ”„ è‡ªåŠ¨æŒ‰åŸŸååˆ†ç»„</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨æ‰€æœ‰é‚®ç®±ä¿¡æ¯
        let mailboxes = [];
        let selectedMailboxIndex = -1;
        let emailListData = [];
        let selectedEmailIndex = -1;

        // åˆ†ç»„ç›¸å…³å˜é‡
        let mailboxGroups = []; // å­˜å‚¨æ‰€æœ‰åˆ†ç»„ä¿¡æ¯ [{name: 'åˆ†ç»„å', color: 1, collapsed: false}]
        let groupCollapsedStates = {}; // å­˜å‚¨åˆ†ç»„æŠ˜å çŠ¶æ€ {groupName: true/false}

        // åˆå§‹åŒ–
        window.onload = function() {
            // ä¸ºæ–‡ä»¶è¾“å…¥æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('fileInput').addEventListener('change', handleFileInput);

            // è®¾ç½®æ‹–æ›³ä¸Šä¼ åŠŸèƒ½
            setupDragAndDrop();

            // è®¾ç½®åˆ†éš”ç¬¦è¾“å…¥æ¡†äº‹ä»¶
            document.getElementById('separatorInput').addEventListener('input', updatePlaceholder);

            // åˆå§‹åŒ–å ä½ç¬¦
            updatePlaceholder();

            // å…ˆåŠ è½½ API å¯†ç å’Œåœ°å€ï¼ˆå¿…é¡»åœ¨ loadMailboxesFromStorage ä¹‹å‰ï¼‰
            const savedApiPassword = localStorage.getItem('apiPassword');
            if (savedApiPassword) {
                document.getElementById('apiPassword').value = savedApiPassword;
            }

            const savedApiBaseUrl = localStorage.getItem('apiBaseUrl');
            if (savedApiBaseUrl) {
                document.getElementById('apiBaseUrl').value = savedApiBaseUrl;
            }

            // å°è¯•ä»localStorageåŠ è½½å·²ä¿å­˜çš„é‚®ç®±ä¿¡æ¯
            loadMailboxesFromStorage();

            // ç¡®ä¿å³ä½¿æ²¡æœ‰ä»localStorageåŠ è½½é‚®ç®±ï¼Œä¹Ÿä¼šæ˜¾ç¤ºç©ºçŠ¶æ€
            updateMailboxList();

            // åˆå§‹åŒ–å½“å‰é‚®ç®±æ˜¾ç¤º
            if (selectedMailboxIndex !== -1 && mailboxes.length > 0) {
                const currentEmailDisplay = document.getElementById('currentEmailDisplay');
                const currentEmailText = document.getElementById('currentEmailText');
                currentEmailText.textContent = mailboxes[selectedMailboxIndex].email;
                currentEmailDisplay.style.display = 'block';
            }

            // å°è¯•ä»localStorageåŠ è½½è®¾ç½®åŒºåŸŸçš„æŠ˜å çŠ¶æ€
            const importSectionCollapsed = localStorage.getItem('importSectionCollapsed');
            if (importSectionCollapsed === 'true') {
                toggleImportSection(false);
            } else {
                // ç¡®ä¿çŠ¶æ€æ–‡æœ¬æ­£ç¡®æ˜¾ç¤º
                document.getElementById('sectionStatus').textContent = 'å±•å¼€';
            }

        };

        // è®¾ç½®æ‹–æ›³ä¸Šä¼ åŠŸèƒ½
        function setupDragAndDrop() {
            const dropzone = document.getElementById('mailboxInput');

            // é˜²æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // é¼ æ ‡æ‹–å…¥æ•ˆæœ
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropzone.classList.add('dragover');
            }

            function unhighlight() {
                dropzone.classList.remove('dragover');
            }

            // å¤„ç†æ‹–å…¥çš„æ–‡ä»¶
            dropzone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length) {
                    const file = files[0];
                    if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            dropzone.value = e.target.result;

                            // æ›´æ–°å ä½ç¬¦æ–‡æœ¬ä»¥åæ˜ å½“å‰åˆ†éš”ç¬¦
                            const separator = document.getElementById('separatorInput').value || '----';
                            dropzone.placeholder = `æ”¯æŒä¸¤ç§æ ¼å¼:\næ ¼å¼1: email${separator}password${separator}client_id${separator}refresh_token\næ ¼å¼2: email${separator}password${separator}refresh_token${separator}client_id`;

                            setStatusMessage('æ–‡ä»¶å·²åŠ è½½ï¼Œè¯·ç‚¹å‡»"æ·»åŠ é‚®ç®±"è¿›è¡Œè§£æ', 'success');
                        };
                        reader.onerror = function() {
                            setStatusMessage('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
                        };
                        reader.readAsText(file);
                    } else {
                        setStatusMessage('è¯·ä¸Šä¼ TXTæ–‡ä»¶', 'error');
                    }
                }
            }
        }

        // æ›´æ–°æ–‡æœ¬åŒºåŸŸçš„å ä½ç¬¦ï¼Œåæ˜ å½“å‰åˆ†éš”ç¬¦
        function updatePlaceholder() {
            const separator = document.getElementById('separatorInput').value || '----';
            document.getElementById('mailboxInput').placeholder = `æ”¯æŒä¸¤ç§æ ¼å¼:\næ ¼å¼1: email${separator}password${separator}client_id${separator}refresh_token\næ ¼å¼2: email${separator}password${separator}refresh_token${separator}client_id`;
        }

        // åˆ‡æ¢è®¾ç½®åŒºåŸŸçš„æŠ˜å /å±•å¼€çŠ¶æ€
        function toggleImportSection(saveState = true) {
            const content = document.getElementById('importContent');
            const toggleBtn = document.getElementById('toggleImportBtn');
            const statusText = document.getElementById('sectionStatus');

            if (content.classList.contains('collapsed')) {
                // å±•å¼€
                content.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                statusText.textContent = 'å±•å¼€';
                if (saveState) localStorage.setItem('importSectionCollapsed', 'false');
            } else {
                // æŠ˜å 
                content.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                statusText.textContent = 'æ”¶èµ·';
                if (saveState) localStorage.setItem('importSectionCollapsed', 'true');
            }
        }

        // ä»localStorageåŠ è½½é‚®ç®±ä¿¡æ¯
        function loadMailboxesFromStorage() {
            const savedMailboxes = localStorage.getItem('mailboxes');
            if (savedMailboxes) {
                try {
                    mailboxes = JSON.parse(savedMailboxes);

                    // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰groupå­—æ®µçš„é‚®ç®±æ·»åŠ é»˜è®¤åˆ†ç»„
                    mailboxes.forEach(mailbox => {
                        if (!mailbox.group) {
                            mailbox.group = getDefaultGroupForEmail(mailbox.email);
                        }
                    });

                    updateMailboxList();
                    setStatusMessage('å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½é‚®ç®±ä¿¡æ¯', 'success');

                    // å¼‚æ­¥æ£€æµ‹æœªçŸ¥çš„ API ç±»å‹
                    detectUnknownApiTypes();
                } catch (error) {
                    console.error('åŠ è½½é‚®ç®±ä¿¡æ¯å¤±è´¥:', error);
                    setStatusMessage('åŠ è½½é‚®ç®±ä¿¡æ¯å¤±è´¥', 'error');
                }
            }
        }

        // æ£€æµ‹æ‰€æœ‰æœªçŸ¥ API ç±»å‹çš„é‚®ç®±
        async function detectUnknownApiTypes() {
            const promises = [];
            mailboxes.forEach((mailbox, index) => {
                // åªæ£€æµ‹æœªè®¾ç½®æˆ–æœªçŸ¥çš„é‚®ç®±
                if (!mailbox.apiType || mailbox.apiType === 'unknown') {
                    promises.push(detectApiType(index));
                }
            });

            if (promises.length > 0) {
                console.log(`å¼€å§‹æ£€æµ‹ ${promises.length} ä¸ªé‚®ç®±çš„ API ç±»å‹...`);
                await Promise.all(promises);
                console.log('API ç±»å‹æ£€æµ‹å®Œæˆ');
            }
        }

        // ä¿å­˜é‚®ç®±ä¿¡æ¯åˆ°localStorage
        function saveMailboxesToStorage() {
            try {
                localStorage.setItem('mailboxes', JSON.stringify(mailboxes));

                // ä¿å­˜APIè®¾ç½®
                const apiPassword = document.getElementById('apiPassword').value;
                if (apiPassword) {
                    localStorage.setItem('apiPassword', apiPassword);
                }

                // å§‹ç»ˆä¿å­˜APIåœ°å€ï¼Œå³ä½¿æ˜¯ç©ºä¹Ÿä¿å­˜ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥æ¸…é™¤å®ƒ
                const apiBaseUrl = document.getElementById('apiBaseUrl').value;
                localStorage.setItem('apiBaseUrl', apiBaseUrl);
            } catch (error) {
                console.error('ä¿å­˜é‚®ç®±ä¿¡æ¯å¤±è´¥:', error);
                setStatusMessage('ä¿å­˜é‚®ç®±ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // å¤„ç†æ–‡ä»¶è¾“å…¥
        function handleFileInput(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('mailboxInput').value = e.target.result;

                // æ›´æ–°å ä½ç¬¦æ–‡æœ¬ä»¥åæ˜ å½“å‰åˆ†éš”ç¬¦
                const separator = document.getElementById('separatorInput').value || '----';
                document.getElementById('mailboxInput').placeholder = `æ”¯æŒä¸¤ç§æ ¼å¼:\næ ¼å¼1: email${separator}password${separator}client_id${separator}refresh_token\næ ¼å¼2: email${separator}password${separator}refresh_token${separator}client_id`;

                setStatusMessage('æ–‡ä»¶å·²åŠ è½½ï¼Œè¯·ç‚¹å‡»"æ·»åŠ é‚®ç®±"è¿›è¡Œè§£æ', 'success');
            };
            reader.onerror = function() {
                setStatusMessage('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            reader.readAsText(file);
        }

        // è§£æé‚®ç®±è¾“å…¥
        async function parseMailboxInput() {
            const input = document.getElementById('mailboxInput').value.trim();
            if (!input) {
                setStatusMessage('è¯·è¾“å…¥é‚®ç®±é…ç½®ä¿¡æ¯', 'error');
                return;
            }

            // å¼¹çª—é€‰æ‹©åˆ†ç»„
            const targetGroup = await showAddMailboxGroupDialog();
            if (targetGroup === null) {
                // ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ
                return;
            }

            // è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„åˆ†éš”ç¬¦ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
            let separator = document.getElementById('separatorInput').value;
            if (!separator) {
                separator = '----';
                document.getElementById('separatorInput').value = separator;
            }

            // æŒ‰è¡Œåˆ†å‰²ï¼Œæ¯è¡Œä¸€ä¸ªé‚®ç®±
            const lines = input.split('\n').filter(line => line.trim() !== '');
            const newMailboxes = [];
            let errorCount = 0;
            let format1Count = 0; // æ ¼å¼1è®¡æ•°ï¼šemail----password----client_id----refresh_token
            let format2Count = 0; // æ ¼å¼2è®¡æ•°ï¼šemail----password----refresh_token----client_id

            for (const line of lines) {
                const parts = line.trim().split(separator);
                if (parts.length < 4) {
                    errorCount++;
                    continue;
                }

                // æ£€æµ‹æ ¼å¼ç±»å‹
                // é€šè¿‡æ£€æŸ¥ç¬¬3ä¸ªå’Œç¬¬4ä¸ªå­—æ®µçš„ç‰¹å¾æ¥åˆ¤æ–­æ ¼å¼
                // client_id é€šå¸¸åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œä¸”è¾ƒé•¿
                // refresh_token é€šå¸¸æ›´é•¿ï¼ŒåŒ…å«ç‰¹æ®Šå­—ç¬¦å¦‚ . - _ ç­‰
                const field3 = parts[2];
                const field4 = parts[3];

                let isFormat1 = false; // email----password----client_id----refresh_token
                let isFormat2 = false; // email----password----refresh_token----client_id

                // åˆ¤æ–­é€»è¾‘ï¼š
                // 1. å¦‚æœç¬¬3ä¸ªå­—æ®µçœ‹èµ·æ¥åƒclient_idï¼ˆè¾ƒçŸ­ï¼Œä¸»è¦æ˜¯å­—æ¯æ•°å­—ï¼‰ï¼Œç¬¬4ä¸ªå­—æ®µåƒrefresh_tokenï¼ˆå¾ˆé•¿ï¼ŒåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼‰
                // 2. å¦‚æœç¬¬3ä¸ªå­—æ®µçœ‹èµ·æ¥åƒrefresh_tokenï¼ˆå¾ˆé•¿ï¼ŒåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼‰ï¼Œç¬¬4ä¸ªå­—æ®µåƒclient_idï¼ˆè¾ƒçŸ­ï¼‰

                if (field3.length < 100 && field4.length > 100 && field4.includes('.')) {
                    // æ ¼å¼1ï¼šemail----password----client_id----refresh_token
                    isFormat1 = true;
                    format1Count++;
                } else if (field3.length > 100 && field3.includes('.') && field4.length < 100) {
                    // æ ¼å¼2ï¼šemail----password----refresh_token----client_id
                    isFormat2 = true;
                    format2Count++;
                } else {
                    // æ— æ³•ç¡®å®šæ ¼å¼ï¼Œå°è¯•é»˜è®¤æ ¼å¼1
                    isFormat1 = true;
                    format1Count++;
                }

                // æ ¹æ®ç”¨æˆ·é€‰æ‹©å†³å®šåˆ†ç»„
                let mailboxGroup;
                if (targetGroup === 'auto') {
                    // è‡ªåŠ¨åˆ†ç»„
                    mailboxGroup = getDefaultGroupForEmail(parts[0]);
                } else if (targetGroup === 'ungrouped') {
                    // æœªåˆ†ç»„
                    mailboxGroup = 'æœªåˆ†ç»„';
                } else {
                    // æŒ‡å®šåˆ†ç»„
                    mailboxGroup = targetGroup;
                }

                if (isFormat1) {
                    newMailboxes.push({
                        email: parts[0],
                        password: parts[1],
                        client_id: parts[2],
                        refresh_token: parts[3],
                        apiType: 'detecting',  // åˆå§‹åŒ–ä¸ºæ£€æµ‹ä¸­
                        group: mailboxGroup
                    });
                } else if (isFormat2) {
                    newMailboxes.push({
                        email: parts[0],
                        password: parts[1],
                        client_id: parts[3],
                        refresh_token: parts[2],
                        apiType: 'detecting',  // åˆå§‹åŒ–ä¸ºæ£€æµ‹ä¸­
                        group: mailboxGroup
                    });
                }
            }

            if (newMailboxes.length === 0) {
                setStatusMessage('æœªæ‰¾åˆ°æœ‰æ•ˆçš„é‚®ç®±é…ç½®', 'error');
                return;
            }

            // æ·»åŠ æ–°çš„é‚®ç®±åˆ°åˆ—è¡¨
            mailboxes = [...mailboxes, ...newMailboxes];
            updateMailboxList();
            saveMailboxesToStorage();

            let message = `å·²æ·»åŠ  ${newMailboxes.length} ä¸ªé‚®ç®±`;
            if (format1Count > 0 && format2Count > 0) {
                message += ` (æ ¼å¼1: ${format1Count}ä¸ª, æ ¼å¼2: ${format2Count}ä¸ª)`;
            } else if (format1Count > 0) {
                message += ` (æ ¼å¼1: email-password-client_id-refresh_token)`;
            } else if (format2Count > 0) {
                message += ` (æ ¼å¼2: email-password-refresh_token-client_id)`;
            }
            if (errorCount > 0) {
                message += `ï¼Œ${errorCount} ä¸ªæ ¼å¼é”™è¯¯è¢«å¿½ç•¥`;
            }
            setStatusMessage(message, 'success');

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('mailboxInput').value = '';

            // å¼‚æ­¥æ£€æµ‹æ–°æ·»åŠ é‚®ç®±çš„ API ç±»å‹
            console.log(`å‡†å¤‡æ£€æµ‹ ${newMailboxes.length} ä¸ªæ–°é‚®ç®±çš„ API ç±»å‹`);
            setTimeout(() => {
                detectApiTypesForNewMailboxes(mailboxes.length - newMailboxes.length, newMailboxes.length);
            }, 100);
        }

        // å¼‚æ­¥æ£€æµ‹é‚®ç®±çš„ API ç±»å‹
        async function detectApiType(mailboxIndex) {
            const mailbox = mailboxes[mailboxIndex];
            if (!mailbox) {
                console.warn(`é‚®ç®±ç´¢å¼• ${mailboxIndex} ä¸å­˜åœ¨`);
                return;
            }

            console.log(`[æ£€æµ‹] é‚®ç®± ${mailbox.email} å½“å‰çŠ¶æ€: ${mailbox.apiType}`);

            // å¦‚æœå·²ç»æœ‰æ˜ç¡®çš„ API ç±»å‹ï¼ˆgraph æˆ– imapï¼‰ï¼Œè·³è¿‡æ£€æµ‹
            if (mailbox.apiType === 'graph' || mailbox.apiType === 'imap') {
                console.log(`[è·³è¿‡] é‚®ç®± ${mailbox.email} å·²æœ‰ API ç±»å‹: ${mailbox.apiType}`);
                return;
            }

            // æ ‡è®°ä¸ºæ£€æµ‹ä¸­
            mailbox.apiType = 'detecting';
            console.log(`[å¼€å§‹] æ£€æµ‹é‚®ç®± ${mailbox.email} çš„ API ç±»å‹`);
            updateMailboxList();
            saveMailboxesToStorage();

            try {
                // è·å– API åŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
                if (!apiBaseUrl) {
                    console.warn('[é”™è¯¯] æœªè®¾ç½® API åœ°å€ï¼Œæ— æ³•æ£€æµ‹ API ç±»å‹');
                    mailbox.apiType = 'unknown';
                    updateMailboxList();
                    saveMailboxesToStorage();
                    return;
                }

                // è·å– API å¯†ç 
                const apiPassword = document.getElementById('apiPassword').value.trim();

                // è°ƒç”¨ token-info API
                const url = `${apiBaseUrl}/token-info?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}&password=${encodeURIComponent(apiPassword)}`;

                console.log(`[è¯·æ±‚] è°ƒç”¨ token-info API: ${apiBaseUrl}/token-info`);

                const response = await fetch(url);
                console.log(`[å“åº”] HTTP çŠ¶æ€: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[é”™è¯¯] HTTP error! status: ${response.status}, body: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(`[æ•°æ®] token-info è¿”å›:`, data);

                if (data.success && data.tokenInfo) {
                    // æ ¹æ® primaryMode è®¾ç½® API ç±»å‹
                    mailbox.apiType = data.tokenInfo.primaryMode || 'unknown';
                    console.log(`[æˆåŠŸ] é‚®ç®± ${mailbox.email} çš„ API ç±»å‹: ${mailbox.apiType}`);
                } else {
                    mailbox.apiType = 'unknown';
                    console.warn(`[è­¦å‘Š] æ— æ³•ç¡®å®šé‚®ç®± ${mailbox.email} çš„ API ç±»å‹ï¼Œè¿”å›æ•°æ®:`, data);
                }
            } catch (error) {
                console.error(`[å¼‚å¸¸] æ£€æµ‹é‚®ç®± ${mailbox.email} çš„ API ç±»å‹å¤±è´¥:`, error);
                mailbox.apiType = 'unknown';
            }

            // æ›´æ–°æ˜¾ç¤ºå’Œå­˜å‚¨
            console.log(`[å®Œæˆ] é‚®ç®± ${mailbox.email} æœ€ç»ˆ API ç±»å‹: ${mailbox.apiType}`);
            updateMailboxList();
            saveMailboxesToStorage();
        }

        // æ‰¹é‡æ£€æµ‹æ–°æ·»åŠ é‚®ç®±çš„ API ç±»å‹
        async function detectApiTypesForNewMailboxes(startIndex, count) {
            console.log(`[æ‰¹é‡æ£€æµ‹] å¼€å§‹æ£€æµ‹ ${count} ä¸ªé‚®ç®±ï¼Œèµ·å§‹ç´¢å¼•: ${startIndex}`);
            const promises = [];
            for (let i = 0; i < count; i++) {
                const index = startIndex + i;
                console.log(`[æ‰¹é‡æ£€æµ‹] æ·»åŠ æ£€æµ‹ä»»åŠ¡: ç´¢å¼• ${index}`);
                promises.push(detectApiType(index));
            }
            console.log(`[æ‰¹é‡æ£€æµ‹] ç­‰å¾… ${promises.length} ä¸ªæ£€æµ‹ä»»åŠ¡å®Œæˆ...`);
            await Promise.all(promises);
            console.log(`[æ‰¹é‡æ£€æµ‹] æ‰€æœ‰æ£€æµ‹ä»»åŠ¡å®Œæˆ`);
        }

        // æ˜¾ç¤ºæ·»åŠ é‚®ç®±åˆ†ç»„é€‰æ‹©å¯¹è¯æ¡†
        function showAddMailboxGroupDialog() {
            return new Promise((resolve) => {
                // åˆ›å»ºæ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.className = 'add-mailbox-group-modal';

                // åˆ›å»ºå¯¹è¯æ¡†å†…å®¹
                const dialog = document.createElement('div');
                dialog.className = 'add-mailbox-group-dialog';

                // æ ‡é¢˜
                const title = document.createElement('h3');
                title.textContent = 'é€‰æ‹©é‚®ç®±åˆ†ç»„';
                dialog.appendChild(title);

                // åˆ†ç»„é€‰æ‹©åŒºåŸŸ
                const selectWrapper = document.createElement('div');
                selectWrapper.className = 'group-select-wrapper';

                const label = document.createElement('label');
                label.textContent = 'è¯·é€‰æ‹©è¦æ·»åŠ åˆ°çš„åˆ†ç»„:';
                selectWrapper.appendChild(label);

                const select = document.createElement('select');
                select.id = 'tempGroupSelect';

                // æ·»åŠ é»˜è®¤é€‰é¡¹
                const autoOption = document.createElement('option');
                autoOption.value = 'auto';
                autoOption.textContent = 'è‡ªåŠ¨åˆ†ç»„';
                select.appendChild(autoOption);

                const ungroupedOption = document.createElement('option');
                ungroupedOption.value = 'ungrouped';
                ungroupedOption.textContent = 'æœªåˆ†ç»„';
                select.appendChild(ungroupedOption);

                // æ·»åŠ ç°æœ‰åˆ†ç»„
                const existingGroups = [...new Set([
                    ...mailboxes.map(m => m.group || 'æœªåˆ†ç»„'),
                    ...mailboxGroups
                ])].filter(g => g !== 'æœªåˆ†ç»„').sort();

                existingGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    select.appendChild(option);
                });

                // æ·»åŠ "æ–°å»ºåˆ†ç»„"é€‰é¡¹
                const newOption = document.createElement('option');
                newOption.value = 'new';
                newOption.textContent = '+ æ–°å»ºåˆ†ç»„...';
                select.appendChild(newOption);

                selectWrapper.appendChild(select);
                dialog.appendChild(selectWrapper);

                // æŒ‰é’®åŒºåŸŸ
                const buttons = document.createElement('div');
                buttons.className = 'dialog-buttons';

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'cancel-btn';
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.onclick = () => {
                    document.body.removeChild(modal);
                    resolve(null);
                };

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'confirm-btn';
                confirmBtn.textContent = 'ç¡®å®š';
                confirmBtn.onclick = async () => {
                    const selectedValue = select.value;

                    if (selectedValue === 'new') {
                        // æ–°å»ºåˆ†ç»„
                        const newGroupName = prompt('è¯·è¾“å…¥æ–°åˆ†ç»„åç§°:');
                        if (!newGroupName || !newGroupName.trim()) {
                            setStatusMessage('æœªè¾“å…¥åˆ†ç»„åç§°', 'error');
                            return;
                        }
                        const groupName = newGroupName.trim();

                        // å°†æ–°åˆ†ç»„æ·»åŠ åˆ°mailboxGroupsæ•°ç»„
                        if (!mailboxGroups.includes(groupName)) {
                            mailboxGroups.push(groupName);
                            saveMailboxesToStorage();
                        }

                        document.body.removeChild(modal);
                        resolve(groupName);
                    } else {
                        document.body.removeChild(modal);
                        resolve(selectedValue);
                    }
                };

                buttons.appendChild(cancelBtn);
                buttons.appendChild(confirmBtn);
                dialog.appendChild(buttons);

                modal.appendChild(dialog);
                document.body.appendChild(modal);

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(null);
                    }
                };
            });
        }

        // æ›´æ–°é‚®ç®±åˆ—è¡¨æ˜¾ç¤ºï¼ˆæ”¯æŒåˆ†ç»„ï¼‰
        function updateMailboxList() {
            const listElement = document.getElementById('mailboxList');
            listElement.innerHTML = '';

            // è·å–æœç´¢å…³é”®è¯
            const searchKeyword = document.getElementById('mailboxSearchInput').value.toLowerCase();

            // æŒ‰åˆ†ç»„ç»„ç»‡é‚®ç®±
            const groupedMailboxes = {};
            mailboxes.forEach((mailbox, index) => {
                // æœç´¢è¿‡æ»¤
                if (searchKeyword && !mailbox.email.toLowerCase().includes(searchKeyword)) {
                    return;
                }

                const groupName = mailbox.group || 'æœªåˆ†ç»„';
                if (!groupedMailboxes[groupName]) {
                    groupedMailboxes[groupName] = [];
                }
                groupedMailboxes[groupName].push({ mailbox, index });
            });

            // æ·»åŠ ç©ºåˆ†ç»„ï¼ˆæ¥è‡ªmailboxGroupsæ•°ç»„ï¼‰
            mailboxGroups.forEach(groupName => {
                if (!groupedMailboxes[groupName]) {
                    groupedMailboxes[groupName] = [];
                }
            });

            // å¦‚æœæ²¡æœ‰é‚®ç®±ä¹Ÿæ²¡æœ‰åˆ†ç»„
            if (mailboxes.length === 0 && mailboxGroups.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.style.position = 'absolute';
                emptyState.style.top = '0';
                emptyState.style.left = '0';
                emptyState.style.right = '0';
                emptyState.style.bottom = '0';
                emptyState.innerHTML = '<p>æ²¡æœ‰é‚®ç®±ï¼Œè¯·å¯¼å…¥æˆ–æ·»åŠ </p>';
                listElement.appendChild(emptyState);
                listElement.style.position = 'relative';
                return;
            }

            // å¦‚æœæœç´¢åæ²¡æœ‰ç»“æœ
            if (Object.keys(groupedMailboxes).length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.style.position = 'absolute';
                emptyState.style.top = '0';
                emptyState.style.left = '0';
                emptyState.style.right = '0';
                emptyState.style.bottom = '0';
                emptyState.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é‚®ç®±</p>';
                listElement.appendChild(emptyState);
                return;
            }

            // æ¸²æŸ“æ¯ä¸ªåˆ†ç»„
            Object.keys(groupedMailboxes).sort().forEach((groupName, groupIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'mailbox-group';

                // è·å–åˆ†ç»„é¢œè‰²
                const colorIndex = (groupIndex % 8) + 1;
                const isCollapsed = groupCollapsedStates[groupName] || false;

                // åˆ›å»ºåˆ†ç»„å¤´éƒ¨
                const groupHeader = document.createElement('div');
                groupHeader.className = `group-header color-${colorIndex}`;
                groupHeader.setAttribute('data-group', groupName);
                groupHeader.onclick = (e) => {
                    if (!e.target.classList.contains('group-action-btn')) {
                        toggleGroupCollapse(groupName);
                    }
                };

                // è®¾ç½®æ‹–æ‹½ç›®æ ‡
                groupHeader.ondragover = (e) => {
                    e.preventDefault();
                    groupHeader.classList.add('drag-over');
                };
                groupHeader.ondragleave = () => {
                    groupHeader.classList.remove('drag-over');
                };
                groupHeader.ondrop = (e) => {
                    e.preventDefault();
                    groupHeader.classList.remove('drag-over');
                    const mailboxIndex = parseInt(e.dataTransfer.getData('mailboxIndex'));
                    moveMailboxToGroup(mailboxIndex, groupName);
                };

                const headerLeft = document.createElement('div');
                headerLeft.className = 'group-header-left';

                const toggleIcon = document.createElement('span');
                toggleIcon.className = 'group-toggle' + (isCollapsed ? ' collapsed' : '');
                toggleIcon.textContent = 'â–¼';

                const groupNameSpan = document.createElement('span');
                groupNameSpan.className = 'group-name';
                groupNameSpan.textContent = groupName;

                const groupCount = document.createElement('span');
                groupCount.className = 'group-count';
                groupCount.textContent = groupedMailboxes[groupName].length;

                headerLeft.appendChild(toggleIcon);
                headerLeft.appendChild(groupNameSpan);

                // åˆ†ç»„æ“ä½œæŒ‰é’®
                const groupActions = document.createElement('div');
                groupActions.className = 'group-actions';

                // é‡å‘½åæŒ‰é’®
                const renameBtn = document.createElement('button');
                renameBtn.className = 'group-action-btn';
                renameBtn.innerHTML = 'âœï¸';
                renameBtn.title = 'é‡å‘½ååˆ†ç»„';
                renameBtn.onclick = (e) => {
                    e.stopPropagation();
                    renameGroup(groupName);
                };

                // åˆ é™¤åˆ†ç»„æŒ‰é’®ï¼ˆä¸åˆ é™¤é‚®ç®±ï¼Œåªæ˜¯ç§»åˆ°æœªåˆ†ç»„ï¼‰
                const deleteGroupBtn = document.createElement('button');
                deleteGroupBtn.className = 'group-action-btn';
                deleteGroupBtn.innerHTML = 'ğŸ—‘ï¸';
                deleteGroupBtn.title = 'åˆ é™¤åˆ†ç»„';
                deleteGroupBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteGroup(groupName);
                };

                if (groupName !== 'æœªåˆ†ç»„') {
                    groupActions.appendChild(renameBtn);
                    groupActions.appendChild(deleteGroupBtn);
                }

                groupHeader.appendChild(headerLeft);
                groupHeader.appendChild(groupCount);
                groupHeader.appendChild(groupActions);

                // åˆ›å»ºåˆ†ç»„å†…å®¹
                const groupContent = document.createElement('div');
                groupContent.className = 'group-content' + (isCollapsed ? ' collapsed' : '');

                groupedMailboxes[groupName].forEach(({ mailbox, index }) => {
                    const item = createMailboxItem(mailbox, index);
                    groupContent.appendChild(item);
                });

                groupDiv.appendChild(groupHeader);
                groupDiv.appendChild(groupContent);
                listElement.appendChild(groupDiv);
            });
        }

        // åˆ›å»ºé‚®ç®±é¡¹å…ƒç´ 
        function createMailboxItem(mailbox, index) {
            const item = document.createElement('li');

            // æ ¹æ® API ç±»å‹æ·»åŠ æ ·å¼ç±»
            let apiTypeClass = 'api-unknown';
            if (mailbox.apiType === 'graph') {
                apiTypeClass = 'api-graph';
            } else if (mailbox.apiType === 'imap') {
                apiTypeClass = 'api-imap';
            } else if (mailbox.apiType === 'detecting') {
                apiTypeClass = 'api-detecting';
            }

            item.className = 'mailbox-item ' + apiTypeClass + (index === selectedMailboxIndex ? ' selected' : '');
            item.setAttribute('draggable', 'true');
            item.onclick = (e) => {
                if (!e.target.classList.contains('delete-mailbox') &&
                    !e.target.classList.contains('view-credentials-btn')) {
                    selectMailbox(index);
                }
            };

            // æ‹–æ‹½äº‹ä»¶
            item.ondragstart = (e) => {
                e.dataTransfer.setData('mailboxIndex', index);
                item.classList.add('dragging');
            };
            item.ondragend = () => {
                item.classList.remove('dragging');
            };

            // æ·»åŠ  API ç±»å‹å›¾æ ‡
            const iconSpan = document.createElement('span');
            iconSpan.className = 'api-type-icon';
            if (mailbox.apiType === 'graph') {
                iconSpan.textContent = 'âš¡';
            } else if (mailbox.apiType === 'imap') {
                iconSpan.textContent = 'ğŸ“®';
            } else if (mailbox.apiType === 'detecting') {
                iconSpan.textContent = 'â³';
                iconSpan.classList.add('detecting');
            } else {
                iconSpan.textContent = 'â“';
            }
            item.appendChild(iconSpan);

            const emailDiv = document.createElement('div');
            emailDiv.className = 'mailbox-email';
            emailDiv.textContent = mailbox.email;

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'mailbox-buttons';

            const viewButton = document.createElement('button');
            viewButton.className = 'view-credentials-btn';
            viewButton.innerHTML = '&#128065;';
            viewButton.title = 'æŸ¥çœ‹é‚®ç®±å‡­æ®';
            viewButton.onclick = (e) => {
                e.stopPropagation();
                showCredentialsModal(index);
            };

            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-mailbox';
            deleteButton.innerHTML = '&#10005;';
            deleteButton.title = 'åˆ é™¤æ­¤é‚®ç®±';
            deleteButton.onclick = (e) => {
                e.stopPropagation();
                deleteMailbox(index);
            };

            buttonsDiv.appendChild(viewButton);
            buttonsDiv.appendChild(deleteButton);

            item.appendChild(emailDiv);
            item.appendChild(buttonsDiv);

            return item;
        }

        // é€‰æ‹©é‚®ç®±
        function selectMailbox(index) {
            selectedMailboxIndex = index;
            updateMailboxList();

            // æ›´æ–°å½“å‰é‚®ç®±æ˜¾ç¤º
            const currentEmailDisplay = document.getElementById('currentEmailDisplay');
            const currentEmailText = document.getElementById('currentEmailText');
            currentEmailText.textContent = mailboxes[index].email;
            currentEmailDisplay.style.display = 'block';

            setStatusMessage(`å·²é€‰æ‹©é‚®ç®±: ${mailboxes[index].email}`, 'success');

            // ç¡®ä¿åˆ‡æ¢åˆ°æ”¶ä»¶ç®±è§†å›¾
            document.getElementById('mailboxFolderList').value = 'INBOX';

            // è‡ªåŠ¨åŠ è½½é‚®ä»¶åˆ—è¡¨å¹¶æ˜¾ç¤ºæœ€æ–°é‚®ä»¶
            loadEmailList(true);
        }

        // æ¸…é™¤æ‰€æœ‰é‚®ç®±
        function clearMailboxes() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é‚®ç®±ä¿¡æ¯å—ï¼Ÿ')) {
                mailboxes = [];
                selectedMailboxIndex = -1;
                updateMailboxList();
                saveMailboxesToStorage();

                // éšè—å½“å‰é‚®ç®±æ˜¾ç¤º
                document.getElementById('currentEmailDisplay').style.display = 'none';

                setStatusMessage('å·²æ¸…é™¤æ‰€æœ‰é‚®ç®±', 'success');
            }
        }

        // è·å–æœ€æ–°é‚®ä»¶ï¼ˆè·¨æ–‡ä»¶å¤¹ï¼‰
        async function fetchEmail() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];

            setStatusMessage('æ­£åœ¨è·å–æœ€æ–°é‚®ä»¶ï¼ˆè·¨æ–‡ä»¶å¤¹ï¼‰...', 'loading');
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('emailFrame').style.display = 'none';
            document.getElementById('emailHeader').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            const responseType = document.getElementById('responseType').value;
            const apiPassword = document.getElementById('apiPassword').value;

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // åŒæ—¶ä»æ”¶ä»¶ç®±å’Œåƒåœ¾ç®±è·å–æœ€æ–°é‚®ä»¶
                const folders = ['INBOX', 'Junk'];
                const emailPromises = folders.map(async (folder) => {
                    let apiUrl = `${apiBaseUrl}/mail-new?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}&mailbox=${folder}&response_type=${responseType}`;

                    // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                    if (apiPassword) {
                        apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                    }

                    console.log(`å‘é€GETè¯·æ±‚åˆ° ${folder}:`, apiUrl);

                    try {
                        const response = await fetch(apiUrl);
                        if (!response.ok) {
                            console.warn(`${folder} APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                            return null;
                        }
                        const data = await response.json();
                        console.log(`æ”¶åˆ° ${folder} æ•°æ®:`, data);

                        // å¤„ç†APIè¿”å›çš„æ•°æ®æ ¼å¼ï¼Œå¯èƒ½æ˜¯å•ä¸ªé‚®ä»¶æˆ–é‚®ä»¶æ•°ç»„
                        let emailData = null;
                        if (Array.isArray(data)) {
                            emailData = data.length > 0 ? data[0] : null; // å–ç¬¬ä¸€å°é‚®ä»¶
                        } else if (data && data.data && Array.isArray(data.data)) {
                            emailData = data.data.length > 0 ? data.data[0] : null; // å–ç¬¬ä¸€å°é‚®ä»¶
                        } else {
                            emailData = data; // å•ä¸ªé‚®ä»¶å¯¹è±¡
                        }

                        // æ ‡è®°é‚®ä»¶æ¥æºæ–‡ä»¶å¤¹
                        if (emailData) {
                            emailData.sourceFolder = folder;
                        }

                        return emailData;
                    } catch (error) {
                        console.warn(`è·å– ${folder} é‚®ä»¶å¤±è´¥:`, error);
                        return null;
                    }
                });

                // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
                const results = await Promise.all(emailPromises);
                const validEmails = results.filter(email => email !== null);

                console.log('æ‰€æœ‰æ–‡ä»¶å¤¹çš„é‚®ä»¶:', validEmails);

                if (validEmails.length === 0) {
                    throw new Error('æ— æ³•ä»ä»»ä½•æ–‡ä»¶å¤¹è·å–é‚®ä»¶');
                }

                // æ¯”è¾ƒé‚®ä»¶æ—¶é—´ï¼Œæ‰¾å‡ºæœ€æ–°çš„é‚®ä»¶
                let latestEmail = null;
                let latestDate = null;

                for (const email of validEmails) {
                    console.log(`å¤„ç† ${email.sourceFolder} æ–‡ä»¶å¤¹çš„é‚®ä»¶:`, email);

                    // è·å–é‚®ä»¶çš„æ—¥æœŸï¼Œå°è¯•å¤šç§å¯èƒ½çš„å­—æ®µ
                    let emailDate = null;
                    let dateSource = '';

                    if (email.date) {
                        emailDate = new Date(email.date);
                        dateSource = 'date';
                    } else if (email.createdDateTime) {
                        emailDate = new Date(email.createdDateTime);
                        dateSource = 'createdDateTime';
                    } else if (email.receivedDateTime) {
                        emailDate = new Date(email.receivedDateTime);
                        dateSource = 'receivedDateTime';
                    } else if (email.timestamp) {
                        emailDate = new Date(email.timestamp);
                        dateSource = 'timestamp';
                    }

                    console.log(`é‚®ä»¶æ—¥æœŸ: ${emailDate} (æ¥æº: ${dateSource})`);

                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºå¤‡é€‰
                    if (!emailDate || isNaN(emailDate.getTime())) {
                        console.warn(`${email.sourceFolder} é‚®ä»¶æ²¡æœ‰æœ‰æ•ˆæ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¶é—´`);
                        emailDate = new Date();
                    }

                    if (!latestDate || emailDate > latestDate) {
                        latestDate = emailDate;
                        latestEmail = email;
                        console.log(`æ›´æ–°æœ€æ–°é‚®ä»¶: ${email.sourceFolder}, æ—¥æœŸ: ${emailDate}`);
                    }
                }

                console.log('æœ€ç»ˆé€‰æ‹©çš„é‚®ä»¶:', latestEmail);

                if (latestEmail) {
                    // æ˜¾ç¤ºåŸå§‹æ•°æ®
                    document.getElementById('rawData').textContent = JSON.stringify(latestEmail, null, 2);

                    // æ˜¾ç¤ºé‚®ä»¶å¤´éƒ¨ä¿¡æ¯
                    document.getElementById('emailFrom').textContent = `å‘ä»¶äºº: ${latestEmail.from || latestEmail.send || 'Unknown'}`;
                    document.getElementById('emailSubject').textContent = latestEmail.subject || 'æ— ä¸»é¢˜';
                    document.getElementById('emailDate').textContent = new Date(latestEmail.date || latestEmail.timestamp || 0).toLocaleString();
                    document.getElementById('emailHeader').style.display = 'block';

                    // æ˜¾ç¤ºé‚®ä»¶å†…å®¹
                    if (latestEmail.html) {
                        displayEmailContent(latestEmail.html);
                    } else if (latestEmail.body) {
                        displayEmailText(latestEmail.body);
                    } else if (latestEmail.text) {
                        displayEmailText(latestEmail.text);
                    } else {
                        setStatusMessage('é‚®ä»¶å†…å®¹ä¸ºç©º', 'error');
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('emptyState').style.display = 'block';
                        return;
                    }

                    const folderName = latestEmail.sourceFolder === 'INBOX' ? 'æ”¶ä»¶ç®±' : 'åƒåœ¾ç®±';
                    setStatusMessage(`å·²è·å–æœ€æ–°é‚®ä»¶ï¼ˆæ¥è‡ª${folderName}ï¼‰`, 'success');
                } else {
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    setStatusMessage('æœªæ‰¾åˆ°æœ‰æ•ˆçš„é‚®ä»¶', 'error');
                }

                // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨ loadEmailList()ï¼Œé¿å…è¦†ç›–è·¨æ–‡ä»¶å¤¹è·å–çš„é‚®ä»¶æ˜¾ç¤º
            } catch (error) {
                console.error('è·å–é‚®ä»¶å¤±è´¥:', error);
                setStatusMessage('è·å–é‚®ä»¶å¤±è´¥: ' + error.message, 'error');
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }



        // æ¸…ç©ºæ”¶ä»¶ç®±
        async function clearInbox() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€é€‰é‚®ç®±çš„æ”¶ä»¶ç®±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            setStatusMessage('æ­£åœ¨æ¸…ç©ºæ”¶ä»¶ç®±...', 'loading');

            const apiPassword = document.getElementById('apiPassword').value;

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // ä½¿ç”¨GETè¯·æ±‚
                let apiUrl = `${apiBaseUrl}/clear-inbox?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}`;

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€GETè¯·æ±‚åˆ°:', apiUrl);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°çš„æ•°æ®:', data);

                // æ˜¾ç¤ºåŸå§‹æ•°æ®
                document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);

                // æ¸…é™¤é‚®ä»¶æ˜¾ç¤º
                clearEmailDisplay();

                // æ¸…ç©ºé‚®ä»¶åˆ—è¡¨
                emailListData = [];
                updateEmailList();

                setStatusMessage('æ”¶ä»¶ç®±æ¸…ç©ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('æ¸…ç©ºæ”¶ä»¶ç®±å¤±è´¥:', error);
                setStatusMessage('æ¸…ç©ºæ”¶ä»¶ç®±å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…ç©ºåƒåœ¾ç®±
        async function clearJunk() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€é€‰é‚®ç®±çš„åƒåœ¾ç®±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            setStatusMessage('æ­£åœ¨æ¸…ç©ºåƒåœ¾ç®±...', 'loading');

            const apiPassword = document.getElementById('apiPassword').value;

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // ä½¿ç”¨GETè¯·æ±‚
                let apiUrl = `${apiBaseUrl}/clear-junk?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}`;

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€GETè¯·æ±‚åˆ°:', apiUrl);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°çš„æ•°æ®:', data);

                // æ˜¾ç¤ºåŸå§‹æ•°æ®
                document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);

                // æ¸…é™¤é‚®ä»¶æ˜¾ç¤º
                clearEmailDisplay();

                // æ¸…ç©ºé‚®ä»¶åˆ—è¡¨
                emailListData = [];
                updateEmailList();

                setStatusMessage('åƒåœ¾ç®±æ¸…ç©ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('æ¸…ç©ºåƒåœ¾ç®±å¤±è´¥:', error);
                setStatusMessage('æ¸…ç©ºåƒåœ¾ç®±å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½é‚®ä»¶åˆ—è¡¨
        async function loadEmailList(autoDisplayLatest = false) {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            const mailboxFolder = document.getElementById('mailboxFolderList').value;
            const apiPassword = document.getElementById('apiPassword').value;

            setStatusMessage(`æ­£åœ¨åŠ è½½${mailboxFolder === 'INBOX' ? 'æ”¶ä»¶ç®±' : 'åƒåœ¾ç®±'}é‚®ä»¶...`, 'loading');

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // ä½¿ç”¨GETè¯·æ±‚
                let apiUrl = `${apiBaseUrl}/mail-all?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}&mailbox=${mailboxFolder}`;

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€GETè¯·æ±‚åˆ°:', apiUrl);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°çš„æ•°æ®:', data);

                // å­˜å‚¨é‚®ä»¶åˆ—è¡¨æ•°æ®
                if (Array.isArray(data)) {
                    emailListData = data;
                } else if (data && data.data && Array.isArray(data.data)) {
                    emailListData = data.data;
                } else {
                    emailListData = [data];
                }

                // æ›´æ–°é‚®ä»¶åˆ—è¡¨æ˜¾ç¤º
                updateEmailList();

                setStatusMessage(`å·²åŠ è½½ ${emailListData.length} å°é‚®ä»¶`, 'success');

                // å¦‚æœéœ€è¦è‡ªåŠ¨æ˜¾ç¤ºæœ€æ–°é‚®ä»¶ä¸”æœ‰é‚®ä»¶æ•°æ®
                if (autoDisplayLatest && emailListData.length > 0) {
                    // æ˜¾ç¤ºå½“å‰æ–‡ä»¶å¤¹çš„æœ€æ–°é‚®ä»¶
                    displayLatestEmailFromCurrentFolder();
                }
            } catch (error) {
                console.error('åŠ è½½é‚®ä»¶åˆ—è¡¨å¤±è´¥:', error);
                setStatusMessage('åŠ è½½é‚®ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');

                // æ¸…ç©ºé‚®ä»¶åˆ—è¡¨
                emailListData = [];
                updateEmailList();
            }
        }

        // æ˜¾ç¤ºå½“å‰æ–‡ä»¶å¤¹çš„æœ€æ–°é‚®ä»¶
        function displayLatestEmailFromCurrentFolder() {
            if (emailListData.length === 0) {
                return;
            }

            // è·å–æœ€æ–°çš„é‚®ä»¶ï¼ˆç¬¬ä¸€ä¸ªï¼‰
            const latestEmail = emailListData[0];

            // æ˜¾ç¤ºåŸå§‹æ•°æ®
            document.getElementById('rawData').textContent = JSON.stringify(latestEmail, null, 2);

            // æ˜¾ç¤ºé‚®ä»¶å¤´éƒ¨ä¿¡æ¯
            document.getElementById('emailFrom').textContent = `å‘ä»¶äºº: ${latestEmail.from || latestEmail.send || 'Unknown'}`;
            document.getElementById('emailSubject').textContent = latestEmail.subject || 'æ— ä¸»é¢˜';
            document.getElementById('emailDate').textContent = new Date(latestEmail.date || latestEmail.timestamp || 0).toLocaleString();
            document.getElementById('emailHeader').style.display = 'block';

            // éšè—åŠ è½½çŠ¶æ€
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            // æ˜¾ç¤ºé‚®ä»¶å†…å®¹
            if (latestEmail.html) {
                displayEmailContent(latestEmail.html);
            } else if (latestEmail.body) {
                displayEmailText(latestEmail.body);
            } else if (latestEmail.text) {
                displayEmailText(latestEmail.text);
            } else {
                setStatusMessage('é‚®ä»¶å†…å®¹ä¸ºç©º', 'error');
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }

            const folderName = document.getElementById('mailboxFolderList').value === 'INBOX' ? 'æ”¶ä»¶ç®±' : 'åƒåœ¾ç®±';
            setStatusMessage(`å·²æ˜¾ç¤º${folderName}æœ€æ–°é‚®ä»¶`, 'success');
        }

        // æ›´æ–°é‚®ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateEmailList() {
            const listElement = document.getElementById('emailList');
            listElement.innerHTML = '';

            // æ›´æ–°é‚®ä»¶æ•°é‡æ˜¾ç¤º
            const emailCountElement = document.getElementById('emailCount');
            if (emailCountElement) {
                emailCountElement.textContent = `(${emailListData.length})`;
            }

            if (emailListData.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.style.position = 'absolute';
                emptyState.style.top = '0';
                emptyState.style.left = '0';
                emptyState.style.right = '0';
                emptyState.style.bottom = '0';
                emptyState.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°é‚®ä»¶</p>';
                listElement.appendChild(emptyState);
                return;
            }

            // æŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
            emailListData.sort((a, b) => {
                const dateA = new Date(a.date || a.timestamp || 0);
                const dateB = new Date(b.date || b.timestamp || 0);
                return dateB - dateA;
            });

            emailListData.forEach((email, index) => {
                const item = document.createElement('li');
                item.className = 'email-item' + (index === selectedEmailIndex ? ' selected' : '');
                item.onclick = () => selectEmail(index);

                const subject = document.createElement('div');
                subject.className = 'email-item-subject';
                subject.textContent = email.subject || 'æ— ä¸»é¢˜';

                const from = document.createElement('div');
                from.className = 'email-item-from';
                from.textContent = `å‘ä»¶äºº: ${email.from || email.send || 'Unknown'}`;

                const date = document.createElement('div');
                date.className = 'email-item-date';
                date.textContent = new Date(email.date || email.timestamp || 0).toLocaleString();

                // æ·»åŠ é‚®ä»¶IDå’Œæ¨¡å¼ä¿¡æ¯æ˜¾ç¤º
                const emailInfo = document.createElement('div');
                emailInfo.className = 'email-item-info';
                emailInfo.style.fontSize = '0.7rem';
                emailInfo.style.color = '#888';
                emailInfo.style.marginTop = '3px';

                const emailId = email.id || email.messageId || 'N/A';
                const emailMode = email.mode || 'unknown';
                const modeColor = emailMode === 'graph' ? '#0066cc' : emailMode === 'imap' ? '#cc6600' : '#666';

                emailInfo.innerHTML = `ID: ${emailId.length > 30 ? emailId.substring(0, 30) + '...' : emailId} | <span style="color: ${modeColor}; font-weight: bold;">${emailMode.toUpperCase()}</span>`;

                item.appendChild(subject);
                item.appendChild(from);
                item.appendChild(date);
                item.appendChild(emailInfo);
                listElement.appendChild(item);
            });
        }

        // é€‰æ‹©é‚®ä»¶
        function selectEmail(index) {
            selectedEmailIndex = index;
            updateEmailList();

            // æ˜¾ç¤ºé€‰ä¸­çš„é‚®ä»¶
            displaySelectedEmail();
        }

        // æ˜¾ç¤ºé€‰ä¸­çš„é‚®ä»¶
        function displaySelectedEmail() {
            if (selectedEmailIndex === -1 || emailListData.length === 0) {
                return;
            }

            const email = emailListData[selectedEmailIndex];

            // æ˜¾ç¤ºé‚®ä»¶å¤´éƒ¨ä¿¡æ¯
            document.getElementById('emailFrom').textContent = `å‘ä»¶äºº: ${email.from || email.send || 'Unknown'}`;
            document.getElementById('emailSubject').textContent = email.subject || 'æ— ä¸»é¢˜';
            document.getElementById('emailDate').textContent = new Date(email.date || email.timestamp || 0).toLocaleString();
            document.getElementById('emailHeader').style.display = 'block';

            // æ˜¾ç¤ºé‚®ä»¶å†…å®¹
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('emailFrame').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            // æ˜¾ç¤ºåŸå§‹æ•°æ®
            document.getElementById('rawData').textContent = JSON.stringify(email, null, 2);

            if (email.html) {
                displayEmailContent(email.html);
            } else if (email.body) {
                displayEmailText(email.body);
            } else if (email.text) {
                displayEmailText(email.text);
            } else {
                setStatusMessage('é‚®ä»¶å†…å®¹ä¸ºç©º', 'error');
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }

            // åˆ‡æ¢åˆ°é‚®ä»¶å†…å®¹æ ‡ç­¾é¡µ
            switchTab('emailTab');

            // æ›´æ–°é‚®ä»¶ç®¡ç†æ ‡ç­¾é¡µä¸­çš„é€‰ä¸­é‚®ä»¶ä¿¡æ¯
            updateSelectedEmailInfo(email);
        }

        // æ˜¾ç¤ºHTMLé‚®ä»¶å†…å®¹
        function displayEmailContent(html) {
            const iframe = document.getElementById('emailFrame');
            iframe.style.display = 'block';

            iframe.contentWindow.document.open();
            iframe.contentWindow.document.write(html);
            iframe.contentWindow.document.close();

            // è°ƒæ•´iframeé«˜åº¦ä»¥é€‚åº”å†…å®¹
            setTimeout(() => {
                try {
                    // ç¡®ä¿iframeå†…å®¹å®Œå…¨åŠ è½½
                    iframe.style.height = '100%';
                } catch (e) {
                    console.error('è°ƒæ•´iframeé«˜åº¦å¤±è´¥:', e);
                }
            }, 100);

            document.getElementById('loadingMessage').style.display = 'none';
            setStatusMessage('é‚®ä»¶åŠ è½½æˆåŠŸ', 'success');
        }

        // æ˜¾ç¤ºçº¯æ–‡æœ¬é‚®ä»¶å†…å®¹
        function displayEmailText(text) {
            const iframe = document.getElementById('emailFrame');
            iframe.style.display = 'block';

            iframe.contentWindow.document.open();
            iframe.contentWindow.document.write(`
                <html>
                <head>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            padding: 20px;
                            margin: 0;
                            height: 100%;
                            overflow: auto;
                        }
                        html { height: 100%; }
                        pre {
                            white-space: pre-wrap;
                            margin: 0;
                        }
                    </style>
                </head>
                <body>
                    <pre>${text}</pre>
                </body>
                </html>
            `);
            iframe.contentWindow.document.close();

            // è°ƒæ•´iframeé«˜åº¦ä»¥é€‚åº”å†…å®¹
            setTimeout(() => {
                try {
                    // ç¡®ä¿iframeå†…å®¹å®Œå…¨åŠ è½½
                    iframe.style.height = '100%';
                } catch (e) {
                    console.error('è°ƒæ•´iframeé«˜åº¦å¤±è´¥:', e);
                }
            }, 100);

            document.getElementById('loadingMessage').style.display = 'none';
            setStatusMessage('é‚®ä»¶åŠ è½½æˆåŠŸ', 'success');
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabId) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.email-container');

            // å–æ¶ˆæ‰€æœ‰æ ‡ç­¾é«˜äº®
            tabs.forEach(tab => tab.classList.remove('active'));

            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            tabContents.forEach(content => content.style.display = 'none');

            // é«˜äº®é€‰ä¸­çš„æ ‡ç­¾
            document.querySelector(`.tab[onclick*="${tabId}"]`).classList.add('active');

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabId).style.display = 'block';

            // å¦‚æœåˆ‡æ¢åˆ°å‘é€é‚®ä»¶æ ‡ç­¾é¡µï¼Œé»˜è®¤å¡«å……æ”¶ä»¶äººä¸ºæµ‹è¯•é‚®ç®±
            if (tabId === 'sendMailTab' && document.getElementById('mailRecipient').value === '') {
                document.getElementById('mailRecipient').value = 'nqaprav26185@outlook.com';
            }
        }

        // æ¸…é™¤é‚®ä»¶æ˜¾ç¤º
        function clearEmailDisplay() {
            document.getElementById('emailHeader').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('emailFrame').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('rawData').textContent = '';
            setStatusMessage('æ˜¾ç¤ºå·²æ¸…é™¤', 'success');

            // é‡ç½®é€‰ä¸­çš„é‚®ä»¶
            selectedEmailIndex = -1;
            if (emailListData.length > 0) {
                updateEmailList();
            }
        }

        // è®¾ç½®çŠ¶æ€æ¶ˆæ¯
        function setStatusMessage(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message ' + type;

            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    if (statusElement.textContent === message) {
                        statusElement.textContent = '';
                        statusElement.className = 'status-message';
                    }
                }, 5000);
            }
        }

        // ä¿å­˜APIè®¾ç½®
        function saveApiSettings() {
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            const apiPassword = document.getElementById('apiPassword').value;

            // ä¿å­˜APIåœ°å€ï¼Œå³ä½¿æ˜¯ç©ºä¹Ÿä¿å­˜
            localStorage.setItem('apiBaseUrl', apiBaseUrl);

            // ä¿å­˜APIå¯†ç ï¼Œå¦‚æœæœ‰çš„è¯
            if (apiPassword) {
                localStorage.setItem('apiPassword', apiPassword);
            }

            setStatusMessage('APIè®¾ç½®å·²ä¿å­˜', 'success');
        }

        // åˆ é™¤å•ä¸ªé‚®ç®±
        function deleteMailbox(index) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤é‚®ç®± ${mailboxes[index].email} å—ï¼Ÿ`)) {
                mailboxes.splice(index, 1);

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„é‚®ç®±ï¼Œé‡ç½®é€‰æ‹©
                if (index === selectedMailboxIndex) {
                    selectedMailboxIndex = -1;
                    // æ¸…é™¤é‚®ä»¶æ˜¾ç¤º
                    clearEmailDisplay();
                    // éšè—å½“å‰é‚®ç®±æ˜¾ç¤º
                    document.getElementById('currentEmailDisplay').style.display = 'none';
                } else if (index < selectedMailboxIndex) {
                    // å¦‚æœåˆ é™¤çš„é‚®ç®±åœ¨å½“å‰é€‰ä¸­çš„é‚®ç®±ä¹‹å‰ï¼Œéœ€è¦è°ƒæ•´ç´¢å¼•
                    selectedMailboxIndex--;
                }

                updateMailboxList();
                saveMailboxesToStorage();
                setStatusMessage('é‚®ç®±å·²åˆ é™¤', 'success');
            }
        }

        // GETæ–¹å¼å‘é€é‚®ä»¶
        async function sendMailGET() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            const recipient = document.getElementById('mailRecipient').value.trim();
            const subject = document.getElementById('mailSubject').value.trim();
            const content = document.getElementById('mailContent').value.trim();
            const apiPassword = document.getElementById('apiPassword').value;
            const contentType = document.querySelector('input[name="contentType"]:checked').value;

            // éªŒè¯è¾“å…¥
            if (!recipient) {
                setStatusMessage('è¯·è¾“å…¥æ”¶ä»¶äººé‚®ç®±', 'error');
                return;
            }
            if (!subject) {
                setStatusMessage('è¯·è¾“å…¥é‚®ä»¶ä¸»é¢˜', 'error');
                return;
            }
            if (!content) {
                setStatusMessage('è¯·è¾“å…¥é‚®ä»¶å†…å®¹', 'error');
                return;
            }

            setStatusMessage('æ­£åœ¨å‘é€é‚®ä»¶...', 'loading');

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // æ„å»ºå‘é€é‚®ä»¶çš„URLï¼ˆGETæ–¹å¼ï¼‰
                let apiUrl = `${apiBaseUrl}/send-mail?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}&to=${encodeURIComponent(recipient)}&subject=${encodeURIComponent(subject)}`;

                // æ ¹æ®å†…å®¹ç±»å‹æ·»åŠ ç›¸åº”çš„å‚æ•°
                if (contentType === 'html') {
                    apiUrl += `&html=${encodeURIComponent(content)}`;
                } else {
                    apiUrl += `&text=${encodeURIComponent(content)}`;
                }

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€GETè¯·æ±‚åˆ°:', apiUrl);
                const response = await fetch(apiUrl);
                const data = await response.json();

                // æ˜¾ç¤ºå‘é€ç»“æœ
                document.getElementById('sendMailResult').style.display = 'block';
                document.getElementById('sendMailResultContent').textContent = JSON.stringify(data, null, 2);

                if (response.ok) {
                    setStatusMessage('é‚®ä»¶å‘é€æˆåŠŸ', 'success');
                } else {
                    setStatusMessage('é‚®ä»¶å‘é€å¤±è´¥: ' + (data.error || data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('å‘é€é‚®ä»¶å¤±è´¥:', error);
                setStatusMessage('å‘é€é‚®ä»¶å¤±è´¥: ' + error.message, 'error');
                document.getElementById('sendMailResult').style.display = 'block';
                document.getElementById('sendMailResultContent').textContent = error.toString();
            }
        }

        // è®¾ç½®å†…å®¹æ¨¡æ¿
        function setContentTemplate(type) {
            const contentArea = document.getElementById('mailContent');

            if (type === 'html' && contentArea.value.trim() === '') {
                // HTMLæ¨¡æ¿
                contentArea.value = `<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #f8f9fa; padding: 10px; text-align: center; }
        .content { padding: 20px; }
        .footer { background-color: #f8f9fa; padding: 10px; text-align: center; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>æµ‹è¯•HTMLé‚®ä»¶</h2>
        </div>
        <div class="content">
            <p>æ‚¨å¥½ï¼</p>
            <p>è¿™æ˜¯ä¸€å°<strong>HTMLæ ¼å¼</strong>çš„æµ‹è¯•é‚®ä»¶ã€‚</p>
            <p>æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šå†…å®¹ã€‚</p>
            <p>ç¥å¥½ï¼</p>
        </div>
        <div class="footer">
            æ­¤é‚®ä»¶ç”±Easy Outlookå‘é€
        </div>
    </div>
</body>
</html>`;
            } else if (type === 'text' && contentArea.value.trim() === '') {
                // çº¯æ–‡æœ¬æ¨¡æ¿
                contentArea.value = `æ‚¨å¥½ï¼

è¿™æ˜¯ä¸€å°çº¯æ–‡æœ¬æ ¼å¼çš„æµ‹è¯•é‚®ä»¶ã€‚
æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šå†…å®¹ã€‚

ç¥å¥½ï¼

æ­¤é‚®ä»¶ç”±Easy Outlookå‘é€`;
            }
        }

        // POSTæ–¹å¼å‘é€é‚®ä»¶
        async function sendMailPOST() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            const recipient = document.getElementById('mailRecipient').value.trim();
            const subject = document.getElementById('mailSubject').value.trim();
            const content = document.getElementById('mailContent').value.trim();
            const apiPassword = document.getElementById('apiPassword').value;
            const contentType = document.querySelector('input[name="contentType"]:checked').value;

            // éªŒè¯è¾“å…¥
            if (!recipient) {
                setStatusMessage('è¯·è¾“å…¥æ”¶ä»¶äººé‚®ç®±', 'error');
                return;
            }
            if (!subject) {
                setStatusMessage('è¯·è¾“å…¥é‚®ä»¶ä¸»é¢˜', 'error');
                return;
            }
            if (!content) {
                setStatusMessage('è¯·è¾“å…¥é‚®ä»¶å†…å®¹', 'error');
                return;
            }

            setStatusMessage('æ­£åœ¨å‘é€é‚®ä»¶...', 'loading');

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // æ„å»ºè¯·æ±‚ä½“
                const formData = new URLSearchParams();
                formData.append('refresh_token', mailbox.refresh_token);
                formData.append('client_id', mailbox.client_id);
                formData.append('email', mailbox.email);
                formData.append('to', recipient);
                formData.append('subject', subject);

                // æ ¹æ®å†…å®¹ç±»å‹æ·»åŠ ç›¸åº”çš„å‚æ•°
                if (contentType === 'html') {
                    formData.append('html', content);
                } else {
                    formData.append('text', content);
                }

                if (apiPassword) {
                    formData.append('password', apiPassword);
                }

                // å‘é€POSTè¯·æ±‚
                console.log('å‘é€POSTè¯·æ±‚åˆ°:', `${apiBaseUrl}/send-mail`);
                const response = await fetch(`${apiBaseUrl}/send-mail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                const data = await response.json();

                // æ˜¾ç¤ºå‘é€ç»“æœ
                document.getElementById('sendMailResult').style.display = 'block';
                document.getElementById('sendMailResultContent').textContent = JSON.stringify(data, null, 2);

                if (response.ok) {
                    setStatusMessage('é‚®ä»¶å‘é€æˆåŠŸ', 'success');
                } else {
                    setStatusMessage('é‚®ä»¶å‘é€å¤±è´¥: ' + (data.error || data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('å‘é€é‚®ä»¶å¤±è´¥:', error);
                setStatusMessage('å‘é€é‚®ä»¶å¤±è´¥: ' + error.message, 'error');
                document.getElementById('sendMailResult').style.display = 'block';
                document.getElementById('sendMailResultContent').textContent = error.toString();
            }
        }

        // æ›´æ–°é€‰ä¸­é‚®ä»¶ä¿¡æ¯æ˜¾ç¤º
        function updateSelectedEmailInfo(email) {
            const infoElement = document.getElementById('selectedEmailInfo');
            if (!email) {
                infoElement.innerHTML = '<div style="color: #666; font-style: italic;">è¯·ä»é‚®ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°é‚®ä»¶</div>';
                return;
            }

            const emailId = email.id || email.messageId || 'N/A';
            const emailMode = email.mode || 'unknown';
            const modeColor = emailMode === 'graph' ? '#0066cc' : emailMode === 'imap' ? '#cc6600' : '#666';

            infoElement.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div><strong>é‚®ä»¶ä¸»é¢˜:</strong> ${email.subject || 'æ— ä¸»é¢˜'}</div>
                    <div><strong>å‘ä»¶äºº:</strong> ${email.from || email.send || 'Unknown'}</div>
                    <div><strong>æ¥æ”¶æ—¶é—´:</strong> ${new Date(email.date || email.timestamp || 0).toLocaleString()}</div>
                    <div><strong>è®¤è¯æ¨¡å¼:</strong> <span style="color: ${modeColor}; font-weight: bold;">${emailMode.toUpperCase()}</span></div>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>é‚®ä»¶ID:</strong>
                    <input type="text" value="${emailId}" readonly style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; background: #f9f9f9; font-family: monospace; font-size: 0.9rem;">
                </div>
                ${email.messageId && email.messageId !== emailId ? `
                <div style="margin-bottom: 10px;">
                    <strong>Message-ID:</strong>
                    <input type="text" value="${email.messageId}" readonly style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; background: #f9f9f9; font-family: monospace; font-size: 0.9rem;">
                </div>
                ` : ''}
                ${email._imapSeqno ? `
                <div style="margin-bottom: 10px;">
                    <strong>IMAPåºåˆ—å·:</strong> ${email._imapSeqno}
                </div>
                ` : ''}
            `;
        }

        // æ£€æµ‹Tokenä¿¡æ¯
        async function checkTokenInfo() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            setStatusMessage('æ­£åœ¨æ£€æµ‹Tokenä¿¡æ¯...', 'loading');

            const apiPassword = document.getElementById('apiPassword').value;

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // ä½¿ç”¨GETè¯·æ±‚
                let apiUrl = `${apiBaseUrl}/token-info?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}`;

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€Tokenæ£€æµ‹è¯·æ±‚åˆ°:', apiUrl);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°çš„Tokenä¿¡æ¯:', data);

                if (data.success && data.tokenInfo) {
                    displayTokenInfo(data.tokenInfo);
                    setStatusMessage('Tokenä¿¡æ¯æ£€æµ‹æˆåŠŸ', 'success');
                    switchTab('tokenInfoTab');
                } else {
                    throw new Error(data.error || 'Tokenä¿¡æ¯æ£€æµ‹å¤±è´¥');
                }
            } catch (error) {
                console.error('Tokenä¿¡æ¯æ£€æµ‹å¤±è´¥:', error);
                setStatusMessage('Tokenä¿¡æ¯æ£€æµ‹å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºTokenä¿¡æ¯
        function displayTokenInfo(tokenInfo) {
            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('tokenEmail').textContent = tokenInfo.email || 'N/A';
            document.getElementById('tokenPrimaryMode').textContent = tokenInfo.primaryMode || 'unknown';
            document.getElementById('tokenSupportedModes').textContent = tokenInfo.supportedModes.join(', ') || 'none';
            document.getElementById('tokenTimestamp').textContent = new Date().toLocaleString();

            // åŠŸèƒ½æ”¯æŒæƒ…å†µ
            document.getElementById('featureReadEmails').textContent = tokenInfo.features.readEmails ? 'âœ…' : 'âŒ';
            document.getElementById('featureDeleteEmails').textContent = tokenInfo.features.deleteEmails ? 'âœ…' : 'âŒ';
            document.getElementById('featureSendEmails').textContent = tokenInfo.features.sendEmails ? 'âœ…' : 'âŒ';
            document.getElementById('featureClearInbox').textContent = tokenInfo.features.clearInbox ? 'âœ…' : 'âŒ';
            document.getElementById('featureClearJunk').textContent = tokenInfo.features.clearJunk ? 'âœ…' : 'âŒ';

            // ä½¿ç”¨å»ºè®®
            const recommendationsList = document.getElementById('tokenRecommendations');
            recommendationsList.innerHTML = '';
            if (tokenInfo.recommendations && tokenInfo.recommendations.length > 0) {
                tokenInfo.recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    li.style.marginBottom = '5px';
                    recommendationsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'æš‚æ— ç‰¹æ®Šå»ºè®®';
                li.style.color = '#666';
                recommendationsList.appendChild(li);
            }

            // Graph APIæƒé™
            const graphCap = tokenInfo.capabilities.graphApi;
            document.getElementById('graphApiSupported').textContent = graphCap.supported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            document.getElementById('graphApiSupported').style.color = graphCap.supported ? '#27ae60' : '#e74c3c';

            if (graphCap.permissions) {
                document.getElementById('graphMailReadWrite').textContent = graphCap.permissions.mailReadWrite ? 'âœ…' : 'âŒ';
                document.getElementById('graphMailRead').textContent = graphCap.permissions.mailRead ? 'âœ…' : 'âŒ';
                document.getElementById('graphUserRead').textContent = graphCap.permissions.userRead ? 'âœ…' : 'âŒ';
            }

            // IMAPæƒé™
            const imapCap = tokenInfo.capabilities.imap;
            document.getElementById('imapSupported').textContent = imapCap.supported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            document.getElementById('imapSupported').style.color = imapCap.supported ? '#27ae60' : '#e74c3c';

            if (imapCap.permissions) {
                document.getElementById('imapAccess').textContent = imapCap.permissions.imapAccess ? 'âœ…' : 'âŒ';
                document.getElementById('popAccess').textContent = imapCap.permissions.popAccess ? 'âœ…' : 'âŒ';
            }

            // æ˜¾ç¤ºTokenä¿¡æ¯åŒºåŸŸ
            document.getElementById('tokenInfoResult').style.display = 'block';
        }

        // æ¸…é™¤Tokenä¿¡æ¯æ˜¾ç¤º
        function clearTokenInfo() {
            document.getElementById('tokenInfoResult').style.display = 'none';
            setStatusMessage('å·²æ¸…é™¤Tokenä¿¡æ¯æ˜¾ç¤º', 'success');
        }

        // æ ¹æ®é‚®ä»¶IDåˆ é™¤é‚®ä»¶
        async function deleteMailById() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            const mailId = document.getElementById('deleteMailId').value.trim();
            if (!mailId) {
                setStatusMessage('è¯·è¾“å…¥è¦åˆ é™¤çš„é‚®ä»¶ID', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é‚®ä»¶IDä¸º "${mailId}" çš„é‚®ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            setStatusMessage('æ­£åœ¨åˆ é™¤é‚®ä»¶...', 'loading');

            const apiPassword = document.getElementById('apiPassword').value;

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // ä½¿ç”¨GETè¯·æ±‚
                let apiUrl = `${apiBaseUrl}/delete-mail?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}&message_id=${encodeURIComponent(mailId)}&confirm=YES`;

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€åˆ é™¤é‚®ä»¶è¯·æ±‚åˆ°:', apiUrl);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°çš„åˆ é™¤ç»“æœ:', data);

                // æ˜¾ç¤ºåˆ é™¤ç»“æœ
                document.getElementById('deleteMailResult').style.display = 'block';
                document.getElementById('deleteMailResultContent').textContent = JSON.stringify(data, null, 2);

                if (data.success) {
                    setStatusMessage('é‚®ä»¶åˆ é™¤æˆåŠŸ', 'success');
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('deleteMailId').value = '';
                    // åˆ·æ–°é‚®ä»¶åˆ—è¡¨
                    loadEmailList();
                } else {
                    setStatusMessage('é‚®ä»¶åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤é‚®ä»¶å¤±è´¥:', error);
                setStatusMessage('åˆ é™¤é‚®ä»¶å¤±è´¥: ' + error.message, 'error');
                document.getElementById('deleteMailResult').style.display = 'block';
                document.getElementById('deleteMailResultContent').textContent = error.toString();
            }
        }

        // ä½¿ç”¨é€‰ä¸­é‚®ä»¶çš„IDå¡«å……åˆ é™¤è¾“å…¥æ¡†
        function fillSelectedEmailId() {
            if (selectedEmailIndex === -1 || emailListData.length === 0) {
                setStatusMessage('è¯·å…ˆä»é‚®ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°é‚®ä»¶', 'error');
                return;
            }

            const email = emailListData[selectedEmailIndex];
            // ä¼˜å…ˆä½¿ç”¨çœŸæ­£çš„Message-ID
            const emailId = email.messageId || email.id || '';

            if (emailId) {
                document.getElementById('deleteMailId').value = emailId;
                setStatusMessage('å·²å¡«å……é€‰ä¸­é‚®ä»¶çš„Message-ID', 'success');
                console.log(`å¡«å……çš„Message-ID: ${emailId}`);
            } else {
                setStatusMessage('é€‰ä¸­é‚®ä»¶æ²¡æœ‰æœ‰æ•ˆçš„ID', 'error');
            }
        }

        // åˆ é™¤é€‰ä¸­çš„é‚®ä»¶
        async function deleteSelectedEmail() {
            if (selectedEmailIndex === -1 || emailListData.length === 0) {
                setStatusMessage('è¯·å…ˆä»é‚®ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€å°é‚®ä»¶', 'error');
                return;
            }

            const email = emailListData[selectedEmailIndex];
            // æ™ºèƒ½é€‰æ‹©IDï¼š
            // - å¦‚æœ id ä»¥ 'imap_' å¼€å¤´ï¼Œè¯´æ˜æ˜¯IMAPæ¨¡å¼ç”Ÿæˆçš„ä¸´æ—¶IDï¼Œåº”ä½¿ç”¨ messageIdï¼ˆRFC 822 Message-IDï¼‰
            // - å¦åˆ™ä½¿ç”¨ idï¼ˆGraph API çš„é‚®ä»¶IDï¼‰
            let emailId;
            if (email.id && email.id.startsWith('imap_')) {
                emailId = email.messageId || email.id;
                console.log('æ£€æµ‹åˆ°IMAPæ¨¡å¼ï¼Œä½¿ç”¨ messageId');
            } else {
                emailId = email.id || email.messageId || '';
                console.log('æ£€æµ‹åˆ°Graph APIæ¨¡å¼ï¼Œä½¿ç”¨ id');
            }

            if (!emailId) {
                setStatusMessage('é€‰ä¸­é‚®ä»¶æ²¡æœ‰æœ‰æ•ˆçš„IDï¼Œæ— æ³•åˆ é™¤', 'error');
                return;
            }

            console.log(`å‡†å¤‡åˆ é™¤é‚®ä»¶ï¼Œä½¿ç”¨ID: ${emailId}`);

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„é‚®ä»¶å—ï¼Ÿ\nä¸»é¢˜: ${email.subject || 'æ— ä¸»é¢˜'}\nå‘ä»¶äºº: ${email.from || email.send || 'Unknown'}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            setStatusMessage('æ­£åœ¨åˆ é™¤é€‰ä¸­é‚®ä»¶...', 'loading');

            const apiPassword = document.getElementById('apiPassword').value;
            // è·å–å½“å‰é€‰æ‹©çš„æ–‡ä»¶å¤¹
            const currentFolder = document.getElementById('mailboxFolderList').value;

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // ä½¿ç”¨delete-mail APIè¿›è¡Œå•ä¸ªé‚®ä»¶åˆ é™¤
                let apiUrl = `${apiBaseUrl}/delete-mail?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}&message_id=${encodeURIComponent(emailId)}&mailbox=${encodeURIComponent(currentFolder)}`;

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€åˆ é™¤é€‰ä¸­é‚®ä»¶è¯·æ±‚åˆ°:', apiUrl);
                console.log(`ä½¿ç”¨delete-mail APIåˆ é™¤å•ä¸ªé‚®ä»¶ï¼ˆæ–‡ä»¶å¤¹: ${currentFolder}ï¼‰`);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°çš„åˆ é™¤ç»“æœ:', data);

                if (data.success) {
                    setStatusMessage('é€‰ä¸­é‚®ä»¶åˆ é™¤æˆåŠŸ', 'success');
                    // åˆ·æ–°é‚®ä»¶åˆ—è¡¨
                    loadEmailList();
                    // æ¸…é™¤é‚®ä»¶æ˜¾ç¤º
                    clearEmailDisplay();
                } else {
                    setStatusMessage('é‚®ä»¶åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤é€‰ä¸­é‚®ä»¶å¤±è´¥:', error);
                setStatusMessage('åˆ é™¤é€‰ä¸­é‚®ä»¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¸¦ç»Ÿè®¡ä¿¡æ¯çš„æ¸…ç©ºæ”¶ä»¶ç®±
        async function clearInboxWithStats() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€é€‰é‚®ç®±çš„æ”¶ä»¶ç®±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            setStatusMessage('æ­£åœ¨æ¸…ç©ºæ”¶ä»¶ç®±...', 'loading');

            const apiPassword = document.getElementById('apiPassword').value;

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // ä½¿ç”¨GETè¯·æ±‚
                let apiUrl = `${apiBaseUrl}/clear-inbox?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}`;

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€æ¸…ç©ºæ”¶ä»¶ç®±è¯·æ±‚åˆ°:', apiUrl);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°çš„æ¸…ç©ºç»“æœ:', data);

                // æ˜¾ç¤ºæ‰¹é‡æ“ä½œç»“æœ
                displayBatchOperationResult(data, 'æ”¶ä»¶ç®±æ¸…ç©º');

                // æ¸…é™¤é‚®ä»¶æ˜¾ç¤º
                clearEmailDisplay();

                // æ¸…ç©ºé‚®ä»¶åˆ—è¡¨
                emailListData = [];
                updateEmailList();

                setStatusMessage('æ”¶ä»¶ç®±æ¸…ç©ºæˆåŠŸ', 'success');
                switchTab('mailManageTab');
            } catch (error) {
                console.error('æ¸…ç©ºæ”¶ä»¶ç®±å¤±è´¥:', error);
                setStatusMessage('æ¸…ç©ºæ”¶ä»¶ç®±å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¸¦ç»Ÿè®¡ä¿¡æ¯çš„æ¸…ç©ºåƒåœ¾ç®±
        async function clearJunkWithStats() {
            if (selectedMailboxIndex === -1) {
                setStatusMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€é€‰é‚®ç®±çš„åƒåœ¾ç®±å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            const mailbox = mailboxes[selectedMailboxIndex];
            setStatusMessage('æ­£åœ¨æ¸…ç©ºåƒåœ¾ç®±...', 'loading');

            const apiPassword = document.getElementById('apiPassword').value;

            try {
                // è·å–APIåŸºç¡€åœ°å€
                const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¡«å†™äº†APIåœ°å€
                if (!apiBaseUrl) {
                    throw new Error('è¯·å…ˆå¡«å†™APIåœ°å€åå†å°è¯•');
                }

                // ä½¿ç”¨GETè¯·æ±‚
                let apiUrl = `${apiBaseUrl}/clear-junk?refresh_token=${encodeURIComponent(mailbox.refresh_token)}&client_id=${encodeURIComponent(mailbox.client_id)}&email=${encodeURIComponent(mailbox.email)}`;

                // å¦‚æœæœ‰è®¾ç½®å¯†ç ï¼Œæ·»åŠ åˆ°URLä¸­
                if (apiPassword) {
                    apiUrl += `&password=${encodeURIComponent(apiPassword)}`;
                }

                console.log('å‘é€æ¸…ç©ºåƒåœ¾ç®±è¯·æ±‚åˆ°:', apiUrl);
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('æ”¶åˆ°çš„æ¸…ç©ºç»“æœ:', data);

                // æ˜¾ç¤ºæ‰¹é‡æ“ä½œç»“æœ
                displayBatchOperationResult(data, 'åƒåœ¾ç®±æ¸…ç©º');

                // æ¸…é™¤é‚®ä»¶æ˜¾ç¤º
                clearEmailDisplay();

                // æ¸…ç©ºé‚®ä»¶åˆ—è¡¨
                emailListData = [];
                updateEmailList();

                setStatusMessage('åƒåœ¾ç®±æ¸…ç©ºæˆåŠŸ', 'success');
                switchTab('mailManageTab');
            } catch (error) {
                console.error('æ¸…ç©ºåƒåœ¾ç®±å¤±è´¥:', error);
                setStatusMessage('æ¸…ç©ºåƒåœ¾ç®±å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡æ“ä½œç»“æœ
        function displayBatchOperationResult(data, operationType) {
            const resultElement = document.getElementById('batchOperationResult');

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('batchMode').textContent = data.mode || 'unknown';
            document.getElementById('batchMode').style.color = data.mode === 'graph' ? '#0066cc' : data.mode === 'imap' ? '#cc6600' : '#666';

            if (data.stats) {
                document.getElementById('batchTotal').textContent = data.stats.total || '0';
                document.getElementById('batchDeleted').textContent = data.stats.deleted || '0';
                document.getElementById('batchFailed').textContent = data.stats.failed || '0';
            } else {
                document.getElementById('batchTotal').textContent = '-';
                document.getElementById('batchDeleted').textContent = '-';
                document.getElementById('batchFailed').textContent = '-';
            }

            // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            document.getElementById('batchOperationDetails').textContent = `${operationType}æ“ä½œå®Œæˆ\n\n${JSON.stringify(data, null, 2)}`;

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultElement.style.display = 'block';
        }

        // å¤åˆ¶å½“å‰é‚®ç®±åœ°å€åˆ°å‰ªè´´æ¿
        function copyCurrentEmail() {
            if (selectedMailboxIndex === -1 || !mailboxes[selectedMailboxIndex]) {
                setStatusMessage('æ²¡æœ‰é€‰ä¸­çš„é‚®ç®±', 'error');
                return;
            }

            const email = mailboxes[selectedMailboxIndex].email;

            // ä½¿ç”¨ç°ä»£çš„ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(email).then(() => {
                    setStatusMessage(`å·²å¤åˆ¶é‚®ç®±åœ°å€: ${email}`, 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(email);
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                fallbackCopyTextToClipboard(email);
            }
        }

        // é™çº§å¤åˆ¶æ–¹æ¡ˆ
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;

            // é¿å…æ»šåŠ¨åˆ°åº•éƒ¨
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    setStatusMessage(`å·²å¤åˆ¶é‚®ç®±åœ°å€: ${text}`, 'success');
                } else {
                    setStatusMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('é™çº§å¤åˆ¶å¤±è´¥:', err);
                setStatusMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }

            document.body.removeChild(textArea);
        }

        // æ˜¾ç¤ºé‚®ç®±å‡­æ®æ¨¡æ€æ¡†
        function showCredentialsModal(mailboxIndex) {
            if (mailboxIndex < 0 || mailboxIndex >= mailboxes.length) {
                setStatusMessage('é‚®ç®±ç´¢å¼•æ— æ•ˆ', 'error');
                return;
            }

            const mailbox = mailboxes[mailboxIndex];

            // å¡«å……æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('modalEmail').textContent = mailbox.email;
            document.getElementById('modalPassword').textContent = mailbox.password;
            document.getElementById('modalClientId').textContent = mailbox.client_id;
            document.getElementById('modalRefreshToken').textContent = mailbox.refresh_token;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('credentialsModal');
            modal.classList.add('show');

            // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeCredentialsModal();
                }
            };
        }

        // å…³é—­é‚®ç®±å‡­æ®æ¨¡æ€æ¡†
        function closeCredentialsModal() {
            const modal = document.getElementById('credentialsModal');
            modal.classList.remove('show');

            // æ¸…é™¤ç‚¹å‡»äº‹ä»¶
            modal.onclick = null;
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
        function copyToClipboard(elementId, buttonElement) {
            const element = document.getElementById(elementId);
            const text = element.textContent;

            if (!text) {
                setStatusMessage('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶', 'error');
                return;
            }

            // å°è¯•ä½¿ç”¨ç°ä»£çš„ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(buttonElement);
                    setStatusMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyToClipboard(text, buttonElement);
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                fallbackCopyToClipboard(text, buttonElement);
            }
        }

        // é™çº§å¤åˆ¶æ–¹æ¡ˆ
        function fallbackCopyToClipboard(text, buttonElement) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(buttonElement);
                    setStatusMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    setStatusMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('é™çº§å¤åˆ¶å¤±è´¥:', err);
                setStatusMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }

            document.body.removeChild(textArea);
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
        function showCopySuccess(buttonElement) {
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'å·²å¤åˆ¶';
            buttonElement.classList.add('copied');

            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.classList.remove('copied');
            }, 2000);
        }

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ŒæŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('credentialsModal');
                if (modal.classList.contains('show')) {
                    closeCredentialsModal();
                }
                const groupModal = document.getElementById('groupManageModal');
                if (groupModal.classList.contains('show')) {
                    closeGroupManageModal();
                }
            }
        });

        // ========== åˆ†ç»„ç®¡ç†ç›¸å…³å‡½æ•° ==========

        // æ ¹æ®é‚®ç®±åœ°å€è·å–é»˜è®¤åˆ†ç»„
        function getDefaultGroupForEmail(email) {
            const domain = email.split('@')[1];
            if (!domain) return 'æœªåˆ†ç»„';

            // å¾®è½¯é‚®ç®±åŸŸåæ˜ å°„
            const domainMap = {
                'outlook.com': 'Outlooké‚®ç®±',
                'hotmail.com': 'Hotmailé‚®ç®±',
                'live.com': 'Liveé‚®ç®±',
                'msn.com': 'MSNé‚®ç®±',
                'outlook.fr': 'Outlookæ³•å›½',
                'outlook.de': 'Outlookå¾·å›½',
                'outlook.jp': 'Outlookæ—¥æœ¬',
                'outlook.co.uk': 'Outlookè‹±å›½'
            };

            return domainMap[domain] || 'å…¶ä»–å¾®è½¯é‚®ç®±';
        }

        // åˆ‡æ¢åˆ†ç»„æŠ˜å çŠ¶æ€
        function toggleGroupCollapse(groupName) {
            groupCollapsedStates[groupName] = !groupCollapsedStates[groupName];
            saveGroupStates();
            updateMailboxList();
        }

        // ç§»åŠ¨é‚®ç®±åˆ°æŒ‡å®šåˆ†ç»„
        function moveMailboxToGroup(mailboxIndex, targetGroup) {
            if (mailboxIndex < 0 || mailboxIndex >= mailboxes.length) return;

            const oldGroup = mailboxes[mailboxIndex].group;
            if (oldGroup === targetGroup) return;

            mailboxes[mailboxIndex].group = targetGroup;
            saveMailboxesToStorage();
            updateMailboxList();
            setStatusMessage(`å·²å°†é‚®ç®±ç§»åŠ¨åˆ° "${targetGroup}"`, 'success');
        }

        // æœç´¢è¿‡æ»¤é‚®ç®±
        function filterMailboxes() {
            updateMailboxList();
        }

        // æ‰“å¼€åˆ†ç»„ç®¡ç†æ¨¡æ€æ¡†
        function openGroupManageModal() {
            updateGroupList();
            document.getElementById('groupManageModal').classList.add('show');
        }

        // å…³é—­åˆ†ç»„ç®¡ç†æ¨¡æ€æ¡†
        function closeGroupManageModal() {
            document.getElementById('groupManageModal').classList.remove('show');
            document.getElementById('newGroupNameInput').value = '';
        }

        // æ›´æ–°åˆ†ç»„åˆ—è¡¨æ˜¾ç¤º
        function updateGroupList() {
            const container = document.getElementById('groupListContainer');
            container.innerHTML = '';

            // ç»Ÿè®¡æ¯ä¸ªåˆ†ç»„çš„é‚®ç®±æ•°é‡
            const groupCounts = {};
            mailboxes.forEach(mailbox => {
                const group = mailbox.group || 'æœªåˆ†ç»„';
                groupCounts[group] = (groupCounts[group] || 0) + 1;
            });

            // åˆå¹¶é‚®ç®±ä¸­çš„åˆ†ç»„å’ŒmailboxGroupsä¸­çš„ç©ºåˆ†ç»„
            const allGroups = new Set([...Object.keys(groupCounts), ...mailboxGroups]);
            const groups = Array.from(allGroups).sort();

            if (groups.length === 0) {
                container.innerHTML = '<div class="no-group-hint">æš‚æ— åˆ†ç»„</div>';
                return;
            }

            groups.forEach(groupName => {
                const itemWrapper = document.createElement('div');

                const item = document.createElement('div');
                item.className = 'group-list-item';

                const nameSpan = document.createElement('span');
                nameSpan.className = 'group-list-item-name';
                nameSpan.textContent = groupName;

                const countSpan = document.createElement('span');
                countSpan.className = 'group-list-item-count';
                countSpan.textContent = `(${groupCounts[groupName] || 0})`;

                const leftDiv = document.createElement('div');
                leftDiv.appendChild(nameSpan);
                leftDiv.appendChild(countSpan);

                // ä¸º"æœªåˆ†ç»„"æ·»åŠ å±•å¼€/æŠ˜å æŒ‰é’®
                if (groupName === 'æœªåˆ†ç»„' && groupCounts[groupName] > 0) {
                    const expandToggle = document.createElement('span');
                    expandToggle.className = 'expand-toggle';
                    expandToggle.textContent = 'â–¼ å±•å¼€';
                    expandToggle.dataset.expanded = 'false';
                    leftDiv.appendChild(expandToggle);
                }

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'group-list-item-actions';

                if (groupName !== 'æœªåˆ†ç»„') {
                    const renameBtn = document.createElement('button');
                    renameBtn.className = 'small-btn';
                    renameBtn.textContent = 'é‡å‘½å';
                    renameBtn.onclick = () => renameGroup(groupName);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'small-btn warning';
                    deleteBtn.textContent = 'åˆ é™¤';
                    deleteBtn.onclick = () => deleteGroup(groupName);

                    actionsDiv.appendChild(renameBtn);
                    actionsDiv.appendChild(deleteBtn);
                }

                item.appendChild(leftDiv);
                item.appendChild(actionsDiv);
                itemWrapper.appendChild(item);

                // ä¸º"æœªåˆ†ç»„"æ·»åŠ é‚®ç®±åˆ—è¡¨å’Œæ“ä½œåŒºåŸŸ
                if (groupName === 'æœªåˆ†ç»„' && groupCounts[groupName] > 0) {
                    const ungroupedContainer = document.createElement('div');
                    ungroupedContainer.className = 'ungrouped-mailboxes';
                    ungroupedContainer.style.display = 'none';

                    // è·å–æ‰€æœ‰æœªåˆ†ç»„çš„é‚®ç®±
                    const ungroupedMailboxes = mailboxes.filter(m => !m.group || m.group === 'æœªåˆ†ç»„');

                    ungroupedMailboxes.forEach((mailbox, index) => {
                        const mailboxItem = document.createElement('div');
                        mailboxItem.className = 'ungrouped-mailbox-item';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `ungrouped-${index}`;
                        checkbox.dataset.email = mailbox.email;

                        const label = document.createElement('label');
                        label.htmlFor = `ungrouped-${index}`;
                        label.textContent = mailbox.email;

                        mailboxItem.appendChild(checkbox);
                        mailboxItem.appendChild(label);
                        ungroupedContainer.appendChild(mailboxItem);
                    });

                    // æ·»åŠ æ“ä½œæŒ‰é’®åŒºåŸŸ
                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'ungrouped-actions';

                    const selectAllBtn = document.createElement('button');
                    selectAllBtn.className = 'small-btn';
                    selectAllBtn.textContent = 'å…¨é€‰';
                    selectAllBtn.onclick = () => toggleSelectAll(ungroupedContainer, true);

                    const deselectAllBtn = document.createElement('button');
                    deselectAllBtn.className = 'small-btn';
                    deselectAllBtn.textContent = 'åé€‰';
                    deselectAllBtn.onclick = () => toggleSelectAll(ungroupedContainer, false);

                    const targetGroupSelect = document.createElement('select');
                    targetGroupSelect.innerHTML = '<option value="">é€‰æ‹©ç›®æ ‡åˆ†ç»„...</option>';

                    // è·å–æ‰€æœ‰å¯ç”¨åˆ†ç»„(åˆå¹¶åå†å»é‡,é¿å…é‡å¤)
                    const availableGroups = [...new Set([...mailboxes.map(m => m.group || 'æœªåˆ†ç»„'), ...mailboxGroups])]
                        .filter(g => g !== 'æœªåˆ†ç»„')
                        .sort();

                    availableGroups.forEach(g => {
                        const option = document.createElement('option');
                        option.value = g;
                        option.textContent = g;
                        targetGroupSelect.appendChild(option);
                    });

                    const moveSelectedBtn = document.createElement('button');
                    moveSelectedBtn.className = 'small-btn primary';
                    moveSelectedBtn.textContent = 'ç§»åŠ¨é€‰ä¸­';
                    moveSelectedBtn.onclick = () => moveSelectedMailboxes(ungroupedContainer, targetGroupSelect);

                    actionsContainer.appendChild(selectAllBtn);
                    actionsContainer.appendChild(deselectAllBtn);
                    actionsContainer.appendChild(targetGroupSelect);
                    actionsContainer.appendChild(moveSelectedBtn);

                    ungroupedContainer.appendChild(actionsContainer);
                    itemWrapper.appendChild(ungroupedContainer);

                    // æ·»åŠ å±•å¼€/æŠ˜å äº‹ä»¶
                    const expandToggle = leftDiv.querySelector('.expand-toggle');
                    expandToggle.onclick = () => {
                        const isExpanded = expandToggle.dataset.expanded === 'true';
                        if (isExpanded) {
                            ungroupedContainer.style.display = 'none';
                            expandToggle.textContent = 'â–¼ å±•å¼€';
                            expandToggle.dataset.expanded = 'false';
                        } else {
                            ungroupedContainer.style.display = 'block';
                            expandToggle.textContent = 'â–² æ”¶èµ·';
                            expandToggle.dataset.expanded = 'true';
                        }
                    };
                }

                container.appendChild(itemWrapper);
            });
        }

        // åˆ›å»ºæ–°åˆ†ç»„
        function createNewGroup() {
            const input = document.getElementById('newGroupNameInput');
            const groupName = input.value.trim();

            if (!groupName) {
                setStatusMessage('è¯·è¾“å…¥åˆ†ç»„åç§°', 'error');
                return;
            }

            // æ£€æŸ¥åˆ†ç»„æ˜¯å¦å·²å­˜åœ¨
            const existingGroups = [...new Set(mailboxes.map(m => m.group || 'æœªåˆ†ç»„')), ...mailboxGroups];
            if (existingGroups.includes(groupName)) {
                setStatusMessage('åˆ†ç»„å·²å­˜åœ¨', 'error');
                return;
            }

            // æ·»åŠ åˆ°mailboxGroupsæ•°ç»„
            mailboxGroups.push(groupName);
            saveGroupStates();

            setStatusMessage(`åˆ†ç»„ "${groupName}" å·²åˆ›å»ºï¼Œå¯ä»¥æ‹–æ‹½é‚®ç®±åˆ°æ­¤åˆ†ç»„`, 'success');
            input.value = '';
            updateGroupList();
            updateMailboxList(); // æ›´æ–°é‚®ç®±åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°åˆ†ç»„
        }

        // é‡å‘½ååˆ†ç»„
        function renameGroup(oldName) {
            const newName = prompt(`é‡å‘½ååˆ†ç»„ "${oldName}"`, oldName);
            if (!newName || newName.trim() === '' || newName === oldName) return;

            const trimmedName = newName.trim();

            // æ£€æŸ¥æ–°åç§°æ˜¯å¦å·²å­˜åœ¨
            const existingGroups = [...new Set(mailboxes.map(m => m.group || 'æœªåˆ†ç»„')), ...mailboxGroups];
            if (existingGroups.includes(trimmedName)) {
                setStatusMessage('åˆ†ç»„åç§°å·²å­˜åœ¨', 'error');
                return;
            }

            // æ›´æ–°æ‰€æœ‰å±äºè¯¥åˆ†ç»„çš„é‚®ç®±
            let count = 0;
            mailboxes.forEach(mailbox => {
                if (mailbox.group === oldName) {
                    mailbox.group = trimmedName;
                    count++;
                }
            });

            // æ›´æ–°mailboxGroupsæ•°ç»„
            const index = mailboxGroups.indexOf(oldName);
            if (index > -1) {
                mailboxGroups[index] = trimmedName;
            }

            // æ›´æ–°æŠ˜å çŠ¶æ€
            if (groupCollapsedStates[oldName] !== undefined) {
                groupCollapsedStates[trimmedName] = groupCollapsedStates[oldName];
                delete groupCollapsedStates[oldName];
            }

            saveMailboxesToStorage();
            saveGroupStates();
            updateMailboxList();
            updateGroupList();
            setStatusMessage(`å·²å°† ${count} ä¸ªé‚®ç®±ä» "${oldName}" é‡å‘½åä¸º "${trimmedName}"`, 'success');
        }

        // åˆ é™¤åˆ†ç»„ï¼ˆæä¾›é€‰é¡¹ï¼šä»…åˆ é™¤åˆ†ç»„æˆ–åˆ é™¤åˆ†ç»„åŠé‚®ç®±ï¼‰
        function deleteGroup(groupName) {
            // ç»Ÿè®¡è¯¥åˆ†ç»„ä¸‹çš„é‚®ç®±æ•°é‡
            const mailboxCount = mailboxes.filter(m => m.group === groupName).length;

            // å¦‚æœæ˜¯ç©ºåˆ†ç»„,ç›´æ¥åˆ é™¤
            if (mailboxCount === 0) {
                deleteEmptyGroup(groupName);
                return;
            }

            // éç©ºåˆ†ç»„,æ˜¾ç¤ºé€‰é¡¹å¯¹è¯æ¡†
            showDeleteGroupDialog(groupName, mailboxCount);
        }

        // åˆ é™¤ç©ºåˆ†ç»„
        function deleteEmptyGroup(groupName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç©ºåˆ†ç»„ "${groupName}" å—?`)) return;

            // ä»mailboxGroupsæ•°ç»„ä¸­ç§»é™¤
            const index = mailboxGroups.indexOf(groupName);
            if (index > -1) {
                mailboxGroups.splice(index, 1);
            }

            delete groupCollapsedStates[groupName];

            saveMailboxesToStorage();
            saveGroupStates();
            updateMailboxList();
            updateGroupList();
            setStatusMessage(`å·²åˆ é™¤ç©ºåˆ†ç»„ "${groupName}"`, 'success');
        }

        // æ˜¾ç¤ºåˆ é™¤åˆ†ç»„é€‰é¡¹å¯¹è¯æ¡†
        function showDeleteGroupDialog(groupName, mailboxCount) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'delete-group-modal';
            modal.innerHTML = `
                <div class="delete-group-dialog">
                    <h3>åˆ é™¤åˆ†ç»„ "${groupName}"</h3>
                    <p class="mailbox-count">è¯¥åˆ†ç»„æœ‰ <strong>${mailboxCount}</strong> ä¸ªé‚®ç®±,è¯·é€‰æ‹©:</p>

                    <div class="delete-options">
                        <label class="delete-option">
                            <input type="radio" name="deleteOption" value="moveToUngrouped" checked>
                            <div class="option-content">
                                <div class="option-title">ä»…åˆ é™¤åˆ†ç»„,é‚®ç®±ç§»å…¥"æœªåˆ†ç»„"</div>
                                <div class="option-desc">(é‚®ç®±ä¿ç•™,å¯é‡æ–°åˆ†ç»„)</div>
                            </div>
                        </label>

                        <label class="delete-option danger">
                            <input type="radio" name="deleteOption" value="deleteAll">
                            <div class="option-content">
                                <div class="option-title">åˆ é™¤åˆ†ç»„åŠæ‰€æœ‰é‚®ç®±</div>
                                <div class="option-desc warning">âš ï¸ é‚®ç®±å°†æ°¸ä¹…åˆ é™¤,ä¸å¯æ¢å¤!</div>
                            </div>
                        </label>
                    </div>

                    <div class="dialog-buttons">
                        <button class="cancel-btn">å–æ¶ˆ</button>
                        <button class="confirm-btn">ç¡®è®¤</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ç»‘å®šäº‹ä»¶
            const cancelBtn = modal.querySelector('.cancel-btn');
            const confirmBtn = modal.querySelector('.confirm-btn');

            cancelBtn.onclick = () => {
                document.body.removeChild(modal);
            };

            confirmBtn.onclick = () => {
                const selectedOption = modal.querySelector('input[name="deleteOption"]:checked').value;
                document.body.removeChild(modal);

                if (selectedOption === 'moveToUngrouped') {
                    deleteGroupMoveMailboxes(groupName, mailboxCount);
                } else {
                    deleteGroupAndMailboxes(groupName, mailboxCount);
                }
            };

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // ä»…åˆ é™¤åˆ†ç»„,é‚®ç®±ç§»å…¥æœªåˆ†ç»„
        function deleteGroupMoveMailboxes(groupName, mailboxCount) {
            mailboxes.forEach(mailbox => {
                if (mailbox.group === groupName) {
                    mailbox.group = 'æœªåˆ†ç»„';
                }
            });

            // ä»mailboxGroupsæ•°ç»„ä¸­ç§»é™¤
            const index = mailboxGroups.indexOf(groupName);
            if (index > -1) {
                mailboxGroups.splice(index, 1);
            }

            delete groupCollapsedStates[groupName];

            saveMailboxesToStorage();
            saveGroupStates();
            updateMailboxList();
            updateGroupList();
            setStatusMessage(`å·²åˆ é™¤åˆ†ç»„ "${groupName}",${mailboxCount} ä¸ªé‚®ç®±å·²ç§»å…¥æœªåˆ†ç»„`, 'success');
        }

        // åˆ é™¤åˆ†ç»„åŠæ‰€æœ‰é‚®ç®±
        function deleteGroupAndMailboxes(groupName, mailboxCount) {
            // åˆ é™¤è¯¥åˆ†ç»„ä¸‹çš„æ‰€æœ‰é‚®ç®±
            for (let i = mailboxes.length - 1; i >= 0; i--) {
                if (mailboxes[i].group === groupName) {
                    mailboxes.splice(i, 1);
                }
            }

            // ä»mailboxGroupsæ•°ç»„ä¸­ç§»é™¤
            const index = mailboxGroups.indexOf(groupName);
            if (index > -1) {
                mailboxGroups.splice(index, 1);
            }

            delete groupCollapsedStates[groupName];

            saveMailboxesToStorage();
            saveGroupStates();
            updateMailboxList();
            updateGroupList();
            setStatusMessage(`å·²åˆ é™¤åˆ†ç»„ "${groupName}" åŠ ${mailboxCount} ä¸ªé‚®ç®±`, 'warning');
        }

        // å…¨é€‰/åé€‰æœªåˆ†ç»„é‚®ç®±
        function toggleSelectAll(container, selectAll) {
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            if (selectAll) {
                checkboxes.forEach(cb => cb.checked = true);
            } else {
                checkboxes.forEach(cb => cb.checked = !cb.checked);
            }
        }

        // ç§»åŠ¨é€‰ä¸­çš„é‚®ç®±
        function moveSelectedMailboxes(container, targetGroupSelect) {
            const targetGroup = targetGroupSelect.value;
            if (!targetGroup) {
                setStatusMessage('è¯·é€‰æ‹©ç›®æ ‡åˆ†ç»„', 'error');
                return;
            }

            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                setStatusMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé‚®ç®±', 'error');
                return;
            }

            const selectedEmails = Array.from(checkboxes).map(cb => cb.dataset.email);
            let count = 0;

            mailboxes.forEach(mailbox => {
                if (selectedEmails.includes(mailbox.email)) {
                    mailbox.group = targetGroup;
                    count++;
                }
            });

            saveMailboxesToStorage();
            updateMailboxList();
            updateGroupList();
            setStatusMessage(`å·²å°† ${count} ä¸ªé‚®ç®±ç§»åŠ¨åˆ° "${targetGroup}"`, 'success');
        }

        // æ‰¹é‡ç§»åŠ¨æœªåˆ†ç»„é‚®ç®±(æ—§ç‰ˆæœ¬,ä¿ç•™å…¼å®¹æ€§)
        function batchMoveUngrouped() {
            // è·å–æ‰€æœ‰æœªåˆ†ç»„çš„é‚®ç®±
            const ungroupedMailboxes = mailboxes.filter(m => !m.group || m.group === 'æœªåˆ†ç»„');

            if (ungroupedMailboxes.length === 0) {
                setStatusMessage('æ²¡æœ‰æœªåˆ†ç»„çš„é‚®ç®±', 'info');
                return;
            }

            // è·å–æ‰€æœ‰å¯ç”¨çš„åˆ†ç»„ï¼ˆæ’é™¤"æœªåˆ†ç»„"ï¼‰
            const allGroups = [...new Set(mailboxes.map(m => m.group || 'æœªåˆ†ç»„')), ...mailboxGroups];
            const availableGroups = allGroups.filter(g => g !== 'æœªåˆ†ç»„').sort();

            if (availableGroups.length === 0) {
                setStatusMessage('è¯·å…ˆåˆ›å»ºåˆ†ç»„', 'error');
                return;
            }

            // æ„å»ºé€‰æ‹©å¯¹è¯æ¡†çš„é€‰é¡¹
            let message = `é€‰æ‹©ç›®æ ‡åˆ†ç»„ï¼Œå°† ${ungroupedMailboxes.length} ä¸ªæœªåˆ†ç»„é‚®ç®±ç§»åŠ¨åˆ°:\n\n`;
            availableGroups.forEach((group, index) => {
                message += `${index + 1}. ${group}\n`;
            });
            message += '\nè¯·è¾“å…¥åˆ†ç»„ç¼–å·:';

            const input = prompt(message);
            if (!input) return;

            const groupIndex = parseInt(input) - 1;
            if (isNaN(groupIndex) || groupIndex < 0 || groupIndex >= availableGroups.length) {
                setStatusMessage('æ— æ•ˆçš„åˆ†ç»„ç¼–å·', 'error');
                return;
            }

            const targetGroup = availableGroups[groupIndex];
            let count = 0;

            mailboxes.forEach(mailbox => {
                if (!mailbox.group || mailbox.group === 'æœªåˆ†ç»„') {
                    mailbox.group = targetGroup;
                    count++;
                }
            });

            saveMailboxesToStorage();
            updateMailboxList();
            updateGroupList();
            closeGroupManageModal();
            setStatusMessage(`å·²å°† ${count} ä¸ªé‚®ç®±ç§»åŠ¨åˆ° "${targetGroup}"`, 'success');
        }

        // è‡ªåŠ¨æŒ‰åŸŸååˆ†ç»„
        function autoGroupByDomain() {
            if (!confirm('ç¡®å®šè¦æŒ‰åŸŸåè‡ªåŠ¨åˆ†ç»„å—ï¼Ÿ\nè¿™å°†è¦†ç›–ç°æœ‰çš„åˆ†ç»„è®¾ç½®ã€‚')) return;

            mailboxes.forEach(mailbox => {
                mailbox.group = getDefaultGroupForEmail(mailbox.email);
            });

            saveMailboxesToStorage();
            updateMailboxList();
            updateGroupList();
            setStatusMessage('å·²æŒ‰åŸŸåè‡ªåŠ¨åˆ†ç»„', 'success');
        }

        // ä¿å­˜åˆ†ç»„æŠ˜å çŠ¶æ€
        function saveGroupStates() {
            try {
                localStorage.setItem('groupCollapsedStates', JSON.stringify(groupCollapsedStates));
                localStorage.setItem('mailboxGroups', JSON.stringify(mailboxGroups));
            } catch (error) {
                console.error('ä¿å­˜åˆ†ç»„çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½åˆ†ç»„æŠ˜å çŠ¶æ€
        function loadGroupStates() {
            try {
                const saved = localStorage.getItem('groupCollapsedStates');
                if (saved) {
                    groupCollapsedStates = JSON.parse(saved);
                }
                const savedGroups = localStorage.getItem('mailboxGroups');
                if (savedGroups) {
                    mailboxGroups = JSON.parse(savedGroups);
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç»„çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åŠ è½½åˆ†ç»„çŠ¶æ€
        loadGroupStates();


    </script>
</body>
</html>
